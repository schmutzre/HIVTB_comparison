---
title: "Data exploration"
author: "Remo Schmutz"
date: "2023-05-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This document summarizes the data exploration and is intended to serve as an overview of the Swiss cohort data.

## Libraries

```{r}
if(!require(pacman)) install.packages("pacman")

pacman:: p_load(
  haven,
  janitor,
  inspectdf,
  flextable,
  epitools,
  rgl,#3dplot
  lme4,
  merTools, #CI for multilevel
  gridExtra,
  tidyverse,
  mgcv,
  boot
  )

width_descr <- 11 / cm(1)
height_descr <- 8 / cm(1)
```

## Data

```{r}
art <- readRDS("../data_clean/art_ch.rds")
art.long <- readRDS("../data_clean/art_ch.long.rds")
tb <- readRDS("../data_clean/tb_ch.rds")
tb.long <- readRDS("../data_clean/tb_ch.long.rds")

source("../utils/functions.R")

```

```{r}
#defining populations
presenting <- art %>% 
  filter(presenting_TB == 1)

not.presenting <- art %>% 
  filter(presenting_TB == 0)

incident <- art %>% 
  filter(case_incident_2m == 1)
```

## Exploration of the study population (Table 1)

```{r table 1}
# Complete study population
age_at_ART_start_hiv <- age_quantiles(art)
gender_prop_hiv <- tabyl(art, sex)
typetb_hiv <- tabyl(art, type_tb_shcs)
source_hiv <- tabyl(art, risk2)
cd4_base_hiv <- cd4_baseline(art)
rna_base_hiv <- rna_baseline(art)
who_stages_hiv <- tabyl(art,who_stage)
art_regimens_hiv <- regimens(art)
drug_comb_hiv <- drug_combinations(art)
tb_resist_hiv <- tabyl(art, tb_drug_resist)

# presenting TB study population
age_at_ART_start_tb <- age_quantiles(presenting)
gender_prop_tb <- tabyl(presenting, sex)
typetb_tb <- tabyl(presenting, type_tb_shcs)
source_hiv_tb <- tabyl(presenting, risk2)
cd4_base_tb <- cd4_baseline(presenting)
rna_base_tb <- rna_baseline(presenting)
who_stages_tb <- tabyl(presenting, who_stage)
art_regimens_tb <- regimens(presenting)
drug_comb_tb <- drug_combinations(presenting)

# Not-presenting TB study population
age_at_ART_start_notb <- age_quantiles(not.presenting)
gender_prop_notb <- tabyl(not.presenting, sex)
typetb_notb <- tabyl(not.presenting, type_tb_shcs)
source_hiv_notb <- tabyl(not.presenting, risk2)
cd4_base_notb <- cd4_baseline(not.presenting)
rna_base_notb <- rna_baseline(not.presenting)
who_stages_notb <- tabyl(not.presenting, who_stage)
art_regimens_notb <- regimens(not.presenting)
drug_comb_notb <- drug_combinations(not.presenting)
```

```{r table 1 plots}
###Baseline CD4/RNA
# Calculate the counts
p1 <- plot_group_counts(art, "Patients starting ART between 2010-2022")
p2 <- plot_group_counts(presenting, "Presenting with TB")
p3 <- plot_group_counts(not.presenting, "Not-presenting with TB")
p4 <- plot_group_counts(incident, "Incident cases")

baseline_plot <- grid.arrange(p1,p2,p3,p4, ncol = 2)

ggsave(filename = "../results/descriptive/baseline_groups_ch.jpeg", plot = baseline_plot, width = 10, height = 5, dpi = 300)

```

## Exploration of the TB study population (Table 2)

```{r table 2}
#age group
custom_breaks <- c(16, 24, 34, 44, 100)

tb <- tb %>% 
  mutate(age_tb = year(date_tb) - born) %>%
  mutate(agegroups = cut(age_tb, breaks = custom_breaks, include.lowest = TRUE)) %>% 
  mutate(agegroups = as.factor(agegroups))

flextable(tabyl(tb, agegroups))

tb %>%
    summarize("25quantil" = quantile(age_tb, 0.25),
              "50quantil" = quantile(age_tb, 0.5),
              "75quantil" = quantile(age_tb, 0.75))

#gender
flextable(tabyl(tb, sex))

#birth country
flextable(tabyl(tb, region_born))

#site of tb
flextable(tabyl(tb, type_tb_shcs)) #TBC = Pulmonary

#cd4 at tb diagnosis
tb %>% 
  summarize("25quantil" = quantile(tb_diag_cd4, 0.25, na.rm = TRUE),
              "50quantil" = quantile(tb_diag_cd4, 0.5, na.rm = TRUE),
              "75quantil" = quantile(tb_diag_cd4, 0.75, na.rm = TRUE),
            "missing" = sum(is.na(tb_diag_cd4)),
            "non-missing" = sum(!is.na(tb_diag_cd4)))


#hiv rna at tb diagnosis
tb %>% 
  summarize("25quantil" = quantile(tb_diag_rna, 0.25, na.rm = TRUE),
              "50quantil" = quantile(tb_diag_rna, 0.5, na.rm = TRUE),
              "75quantil" = quantile(tb_diag_rna, 0.75, na.rm = TRUE),
            "missing" = sum(is.na(tb_diag_rna)),
            "non-missing" = sum(!is.na(tb_diag_rna)))
```

## Endpoints (Table 3)

Remarks: We defined incident as TB diagnosis after two months of starting ART. For this reason we'll exclude the patients with a TB case before that and begin counting the person years after the second month.

```{r}
#incidence of viral non-suppression
rna_supression_treshold <- 400
cd4_suppression_treshold <- 350

# Sorting the data by id and date
lab_long <- art.long %>% 
  arrange(id, labdate) %>% 
  filter(labdate > art_start_date)

# Creating the next_rna_value, next_cd4_value, and next_labdate columns
lab_long_next <- lab_long %>% 
  group_by(id) %>% 
  mutate(next_rna = lead(rna, order_by = labdate),
         next_cd4 = lead(cd4, order_by = labdate),
         next_labdate = lead(labdate, order_by = labdate)) # add the next_labdate column

# Filter the rows where both the current and next rna_value are >400 and cd4_value are <350
non_suppression_dates <- lab_long_next %>%
  group_by(id) %>%
  filter(rna > rna_supression_treshold & next_rna > rna_supression_treshold & cd4 < cd4_suppression_treshold & next_cd4 < cd4_suppression_treshold) %>%
  slice_min(next_labdate, n = 1) %>% # Use slice_min on next_labdate
  dplyr::select(id, next_labdate)   # Select next_labdate instead of labdate

# Print non_suppression_dates to see the results
print(non_suppression_dates)

suppression_dates <- lab_long_next %>%
  group_by(id) %>%
  filter(rna < rna_supression_treshold & next_rna < rna_supression_treshold & cd4 > cd4_suppression_treshold & next_cd4 > cd4_suppression_treshold) %>%
  slice_min(next_labdate, n = 1) %>% 
  dplyr::select(id, next_labdate)

# Joining the suppression_dates with hiv
hiv_nonsup <- left_join(art, non_suppression_dates, by = "id") %>% 
  rename(viral_non_suppression = next_labdate)

hiv_sup <- left_join(art, suppression_dates, by = "id") %>% 
  rename(viral_suppression = next_labdate)

viral_non_suppression_incidence <- hiv_nonsup %>%
  dplyr::select(id, viral_non_suppression, art_start_date, exitdate , last_persontime) %>% 
  mutate(persontime_years = case_when(
           !is.na(viral_non_suppression)~ as.numeric(difftime(viral_non_suppression, art_start_date, units = "days")/360),
           is.na(viral_non_suppression) ~ last_persontime/360
         )) %>% 
  filter(persontime_years > 0) %>% 
  summarise(sup_incidence = sum(!is.na(viral_non_suppression)), 
            person_years = sum(persontime_years)/1000) %>% 
  mutate(pois = pois.exact(x = sup_incidence, pt = person_years, conf.level = 0.95))

viral_suppression_incidence <- hiv_sup %>%
  dplyr::select(id, viral_suppression, art_start_date, exitdate) %>% 
  mutate(persontime = ifelse(!is.na(viral_suppression),
                            as.numeric(difftime(viral_suppression, art_start_date, units = "days")) / 360,
                            ifelse(!is.na(exitdate),
                                    as.numeric(difftime(exitdate, art_start_date, units = "days")) / 360,  
                                    as.numeric(difftime(as.Date("2022-12-31"), art_start_date, units = "days")) /360  
                             ))) %>% 
  summarise(sup_incidence = sum(!is.na(viral_suppression)), 
            person_years = sum(persontime)/1000) %>% 
  mutate(pois = pois.exact(x = sup_incidence, pt = person_years, conf.level = 0.95))


#time to viral suppression

time_to_virnonsup <- hiv_nonsup %>% 
  dplyr::select(id, viral_non_suppression, art_start_date) %>% 
  mutate(time_to_sup = as.numeric(viral_non_suppression-art_start_date)) %>% 
  summarise(med = median(time_to_sup, na.rm = TRUE),
            "25" = quantile(time_to_sup, 0.25, na.rm = TRUE),
            "75" = quantile(time_to_sup, 0.75, na.rm = TRUE))

time_to_virsup <- hiv_sup %>% 
  dplyr::select(id, viral_suppression, art_start_date) %>% 
  mutate(time_to_sup = as.numeric(viral_suppression-art_start_date)) %>% 
  summarise(med = median(time_to_sup, na.rm = TRUE),
            "25" = quantile(time_to_sup, 0.25, na.rm = TRUE),
            "75" = quantile(time_to_sup, 0.75, na.rm = TRUE))
dx
```

## Plots
```{r}
lab_distribution <- ch_lab_long %>% 
  filter(!is.na(cd4) | !is.na(rna)) %>% 
  ggplot(aes(x= time_diff)) +
  geom_histogram(fill = "darkblue") +
  labs(x="days difference from art start", title = "Distribution of non-NA lab-measurements") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) 

ggsave(plot = lab_distribution, filename = "../results/lab_distribution.png", width = width_descr, height = height_descr)
```

```{r plots for meeting}
ch_lab_long <- ch_lab_long %>%
  mutate(year = round(time_diff / 365))

ch_lab_long %>% 
  group_by(year) %>% 
  summarise(med = median(rna, na.rm = TRUE))

ch_lab_sum <- ch_lab_long %>%
  group_by(year) %>%
  mutate(rna = log10(rna + 1)) %>% 
  summarise(
    median_cd4 = median(cd4, na.rm = TRUE),
    lower_cd4 = quantile(cd4, 0.25, na.rm = TRUE),
    higher_cd4 = quantile(cd4, 0.75, na.rm = TRUE),
    mean_cd4 = mean(cd4, na.rm = TRUE),
    median_rna = median(rna, na.rm = TRUE),
    lower_rna = quantile(rna,0.25, na.rm = TRUE),    
    higher_rna = quantile(rna, 0.75, na.rm =TRUE),
    mean_rna = mean(rna, na.rm = TRUE)
  )

## cd4 over years
cd4_quantile <- ch_lab_long %>% 
  ggplot(aes(x= year)) +
  geom_line(aes(group = factor(id), y = cd4), color = "grey", alpha = .5)+
  geom_line(data= ch_lab_sum,
            aes(y=mean_cd4),
            color = "darkgreen") +
  geom_errorbar(data = ch_lab_sum, 
                aes(ymin = lower_cd4, ymax = higher_cd4), 
                width = 0.2, color = "black") +
  geom_point(data = ch_lab_sum, 
             aes(y = median_cd4), 
             size = 1, color = "red")+
  geom_hline(yintercept =350) +
  theme_bw() +
  labs(x= "year difference from labdate to ART start")

cd4_quantile

ggsave(plot = cd4_quantile, filename = "../results/cd4_quantile.png", width = width_descr, height = height_descr)

### rna

rna_quantile <- ch_lab_long %>% 
  ggplot(aes(x= year)) +
  geom_line(aes(group = factor(id), y = log10(rna)), color = "grey", alpha = .5)+
  geom_line(data= ch_lab_sum,
            aes(y=mean_rna),
            color = "darkgreen") +
  geom_errorbar(data = ch_lab_sum, 
                aes(ymin = lower_rna, ymax = higher_rna), 
                width = 0.2, color = "black") +
  geom_point(data = ch_lab_sum, 
             aes(y = median_rna), 
             size = 1, color = "red")+
  theme_bw() +
  geom_hline(yintercept = log10(400)) +
  labs(x= "year difference from labdate to ART start") 

rna_quantile

ggsave(plot = rna_quantile, filename = "../results/rna_quantile.png", width = width_descr, height = height_descr)

# checking the weird shape of the rna plot
zero_rna <- ch_lab_long %>% 
  group_by(year) %>% 
  summarise(zero_rna = sum(rna == 0, na.rm = TRUE), non_zero = sum(rna != 0, na.rm = TRUE), nA = sum(is.na(rna)))

rna_measurements <- zero_rna %>% 
  ggplot(aes(x=year)) +
  geom_point(aes(y= zero_rna, color = "zero_rna"), size = 1) +
  geom_point(aes(y= non_zero, color = "non_zero"), size = 1) +
  geom_point(aes(y = nA, color = "nA"), size = 1) +
  scale_y_continuous(limits = c(0,20000)) +
  scale_color_manual(values = c("zero_rna" = "red", "non_zero" = "blue", "nA" = "grey"),
                     labels = c("zero_rna" = "rna=0", "non_zero" = "rna != 0", "nA" = "NA")) +
  guides(color = guide_legend(title = NULL)) +
  theme_bw() +
  labs(y=("number of rna measurements"), x = "year difference to ART start")

ggsave(plot = rna_measurements, filename = "../results/rna_meas.png", width = width_descr, height = height_descr)

```

```{r plot presenting with TB}
lab_longTB.cd4 <- ch_lab_long %>% 
  filter(date_tb >= art_start_date-365,
         !is.na(cd4)) %>% 
  mutate(prevalence = if_else(date_tb < art_start_date + 60, TRUE, FALSE),
         ARTtoTB = date_tb-art_start_date) %>%
  group_by(id) %>%
  mutate(min_diff_date = labdate[which.min(abs(labdate - date_tb))]) %>%
  ungroup() %>% 
  mutate(min_diff_date_days = as.numeric(min_diff_date-art_start_date),
         min_diff_date_cd4 = if_else(min_diff_date_days == time_diff, sqrt(cd4), NA_real_))

lab_longTB.rna <- ch_lab_long %>% 
  filter(date_tb >= art_start_date-365,
         !is.na(rna)) %>% 
  mutate(prevalence = if_else(date_tb < art_start_date + 60, TRUE, FALSE),
         ARTtoTB = date_tb-art_start_date,
         log10rna = log10(rna + 1)) %>%
  group_by(id) %>%
  mutate(min_diff_date = labdate[which.min(abs(labdate - date_tb))]) %>%
  ungroup() %>% 
  mutate(min_diff_date_days = as.numeric(min_diff_date-art_start_date),
         min_diff_date_rna = if_else(min_diff_date_days == time_diff, log10rna, NA_real_))

colors <- rainbow(55)

lab_longTB.rna %>% 
  group_by(id) %>% 
  summarise(sum = sum(!is.na(min_diff_date_rna)))

#cd4
plot.cd4_points <- lab_longTB.cd4 %>% 
  filter(prevalence == TRUE) %>% 
  ggplot(aes(x = time_diff, color = factor(id))) +
  geom_line(aes(group = factor(id), y = sqrt(cd4)), alpha = .2) +
  geom_point(aes(group = factor(id), y = sqrt(cd4)), alpha = .2) +
  geom_hline(yintercept = sqrt(350)) +
  geom_point(aes(x=ARTtoTB, y = min_diff_date_cd4), shape = 13, size = 3)+
  labs(x = "Days since ART start") +
ylab("Square root of CD4 count") +
  scale_y_continuous(limits = c(0,40), expand = c(0,0))+
  scale_x_continuous(limits = c(-360,360), expand = c(0,0))+
  theme_bw() +
  theme(legend.position = "none") 

print(plot.cd4_points)

#rna
plot.rna_points <- lab_longTB.rna %>% 
  filter(prevalence == TRUE) %>% 
  ggplot(aes(x = time_diff, color = factor(id))) +
  geom_line(aes(group = factor(id), y = log10rna), alpha = .2) +
  geom_point(aes(group = factor(id), y = log10rna), alpha = .2) +
  geom_hline(yintercept = log10(400)) +
  geom_point(aes(x=ARTtoTB, y = min_diff_date_rna), shape = 13, size = 3)+
  labs(x = "Days since ART start") +
  xlim(c(-360,360))+
  scale_y_continuous(limits = c(0,7.5), expand = c(0,0))+
  ylab(expression(log[10]("cd4"))) +
  theme_bw() +
  ylab("log10(rna+1)")+
  theme(legend.position = "none") 

print(plot.rna_points)

## saving 

points.presenting <- grid.arrange(plot.cd4_points, plot.rna_points, ncol=2, 
             top = "TB dates and lab data for 55 Patients presenting with TB") 

ggsave(plot = points.presenting, filename = "../results/plots_lab/points.presenting.png", width = width_descr*2, height = height_descr)
```

```{r plot incident cases}
#cd4

plot.cd4_pointsINC <- lab_longTB.cd4 %>% 
  filter(prevalence == FALSE) %>% 
  ggplot(aes(x = time_diff, color = factor(id))) +
  geom_line(aes(group = factor(id), y = sqrt(cd4)), alpha = .5) +
  geom_point(aes(group = factor(id), y = sqrt(cd4))) +
  geom_hline(yintercept = sqrt(350)) +
  geom_point(aes(x=ARTtoTB, y = min_diff_date_cd4), shape = 13, size = 3)+
  labs(x = "Days since ART start") +
  ylab("Square root of CD4 count") +
  theme_bw() +
  theme(legend.position = "none") +
  scale_x_continuous(limits = c(0, 3000))

print(plot.cd4_pointsINC)

#rna
plot.rna_pointsINC <- lab_longTB.rna %>% 
  filter(prevalence == FALSE) %>% 
  ggplot(aes(x = time_diff, color = factor(id))) +
  geom_line(aes(group = factor(id), y = log10rna), alpha = .5) +
  geom_point(aes(group = factor(id), y = log10rna)) +
  geom_hline(yintercept = log10(400)) +
  geom_point(aes(x = ARTtoTB, y = min_diff_date_rna), shape = 13, size = 3) +
  labs(x = "Days since ART start") +
  ylim(c(-.5, 7.5)) +
  ylab(expression(log[10]("cd4"))) +
  theme_bw() +
  ylab("log10(rna+1)") +
  theme(legend.position = "none") +
  scale_x_continuous(limits = c(0, 3000))

print(plot.rna_pointsINC)

points.presentingINC <- grid.arrange(plot.cd4_pointsINC, plot.rna_pointsINC, ncol=2, 
             top = "TB dates and lab data for 15 TB incident patients") 

ggsave(plot = points.presentingINC, filename = "../results/plots_lab/points.presentingINC.png", width = width_descr*2, height = height_descr)

```

```{r plotly}
library(plotly)

ggplotly(plot.cd4_points)
ggplotly(plot.rna_points)
ggplotly(plot.cd4_pointsINC)
ggplotly(plot.rna_pointsINC)

```

```{r t(0) = art}
tb20102022long<-readRDS("../data_clean/tb20102022long.rds")
#### plot t(0) = art start

tb20102022df <- tb20102022long %>% 
  mutate(timediffTB = as.numeric(date_tb - art_start_date)) %>% 
  filter(timediffTB < time_diff) %>% 
  group_by(id) %>%
  mutate(min_diff_date = labdate[which.min(abs(labdate - date_tb))]) %>%
  ungroup() %>% 
  mutate(min_diff_date_days = as.numeric(min_diff_date-art_start_date),
         min_diff_date_cd4 = if_else(min_diff_date_days == time_diff, sqrt(cd4), NA_real_),
         min_diff_date_rna = if_else(min_diff_date_days == time_diff, log10(rna+1), NA_real_)) %>% 
  ungroup()

new_dataTB <- data.frame(
  time_diff = seq(min(tb20102022df$time_diff), max(tb20102022df$time_diff), length.out = 1000),
  id = rep(unique(tb20102022df$id)[1], 1000)  # use the first unique id
)

model_cd4_splineTB <- gam(sqrt(cd4) ~ s(time_diff) + s(id, bs="re"), data = tb20102022df, method = "REML")
#Restricted Maximum Likelihood (REML) estimation method

# Function to fit the model and generate predictions
fit_and_predictCD4 <- function(data, indices) {
  # Fit the model with the specified indices
  fit <- gam(sqrt(cd4) ~ s(time_diff) + s(id, bs="re"), data = data[indices, ], method = "REML")
  
  # Generate predictions
  pred <- predict(fit, newdata = new_dataTB)
  
  return(pred)
}

# Set seed for reproducibility
set.seed(123)

# Bootstrap predictions
boot_preds.cd4_splineTB <- boot(data = tb20102022df, statistic = fit_and_predictCD4, R = 100)

# Calculate percentiles for prediction intervals
lower_bound.cd4_splineTB <- apply(boot_preds.cd4_splineTB$t, 2, quantile, probs = 0.025)
upper_bound.cd4_splineTB <- apply(boot_preds.cd4_splineTB$t, 2, quantile, probs = 0.975)
fitted.cd4_splineTB <- apply(boot_preds.cd4_splineTB$t, 2, mean)

# Combine into a data frame
boot_df.cd4_splineTB <- data.frame(time_diff = new_dataTB$time_diff, lower_bound.cd4_splineTB, upper_bound.cd4_splineTB, fitted.cd4_splineTB)

## Plot 

cd4_yearFITTB <- boot_df.cd4_splineTB %>%
  ggplot(aes(x = time_diff)) +
  geom_hline(yintercept = sqrt(350)) +
  geom_vline(xintercept = 0, linetype = "dashed")+
  geom_line(data = tb20102022df, aes(x = time_diff, y = sqrt(cd4), group = factor(id), color = factor(id)), linewidth = .8, show.legend = FALSE, alpha = .2) +
  geom_point(data = tb20102022df, aes(x = time_diff, y = sqrt(cd4), group = factor(id), color = factor(id)), size = .8, show.legend = FALSE, alpha = .2) +
  geom_point(data = tb20102022df, aes(x = timediffTB, y = min_diff_date_cd4, group = factor(id), color = factor(id)), size = 2, show.legend = FALSE) +
  geom_line(aes(y = fitted.cd4_splineTB), color = "blue") +
  geom_ribbon(aes(ymin = lower_bound.cd4_splineTB, ymax = upper_bound.cd4_splineTB), alpha = 0.2, fill = "blue") +
  theme_bw()+
  labs(x = "Days since ART start", y = "Square root of CD4 count")

print(cd4_yearFITTB)

## RNA

model_rna_splineTB <- gam(log10(rna+1) ~ s(time_diff) + s(id, bs="re"), data = tb20102022df, method = "REML")
#Restricted Maximum Likelihood (REML) estimation method

# Function to fit the model and generate predictions
fit_and_predictRNA <- function(data, indices) {
  # Fit the model with the specified indices
  fit <- gam(log10(rna+1) ~ s(time_diff) + s(id, bs="re"), data = data[indices, ], method = "REML")
  
  # Generate predictions
  pred <- predict(fit, newdata = new_dataTB)
  
  return(pred)
}

# Set seed for reproducibility
set.seed(123)

# Bootstrap predictions
boot_preds.rna_splineTB <- boot(data = tb20102022df, statistic = fit_and_predictRNA, R = 100)

# Calculate percentiles for prediction intervals
lower_bound.rna_splineTB <- apply(boot_preds.rna_splineTB$t, 2, quantile, probs = 0.025)
upper_bound.rna_splineTB <- apply(boot_preds.rna_splineTB$t, 2, quantile, probs = 0.975)
fitted.rna_splineTB <- apply(boot_preds.rna_splineTB$t, 2, mean)

# Combine into a data frame
boot_df.rna_splineTB <- data.frame(time_diff = new_dataTB$time_diff, lower_bound.rna_splineTB, upper_bound.rna_splineTB, fitted.rna_splineTB)

## Plot 

rna_yearFITTB <- boot_df.rna_splineTB %>%
  ggplot(aes(x = time_diff)) +
  geom_hline(yintercept = log10(400)) +
  geom_vline(xintercept = 0, linetype = "dashed")+
  geom_line(data = tb20102022df, aes(x = time_diff, y = log10(rna+1), group = factor(id), color = factor(id)), linewidth = .8, show.legend = FALSE, alpha = .2) +
  geom_point(data = tb20102022df, aes(x = time_diff, y = log10(rna+1), group = factor(id), color = factor(id)), size = .8, show.legend = FALSE, alpha =.2) +
  geom_point(data = tb20102022df, aes(x = timediffTB, y = min_diff_date_rna, color = factor(id)), size = 2, show.legend = FALSE) +
  geom_line(aes(y = fitted.rna_splineTB), color = "blue") +
  geom_ribbon(aes(ymin = lower_bound.rna_splineTB, ymax = upper_bound.rna_splineTB), alpha = 0.2, fill = "blue") +
  theme_bw()+
  labs(x = "Days since ART start", y = "Log10 of RNA viral load")

print(rna_yearFITTB)

#### inspecting ids that are suspect

TB_plotARTzero <- grid.arrange(cd4_yearFITTB, rna_yearFITTB, ncol = 2,
                               top = "Starting from TB date for every ID")

ggsave(plot = TB_plotARTzero, filename = "../results/plots_lab/TBARTzero.png", width = width_descr*2, height = height_descr)
```

```{r t(0)= tb}
tb20102022df2 <- tb20102022long %>% 
  mutate(timediffTB = as.numeric(labdate - date_tb)) %>% 
  filter(labdate < art_start_date, 
         date_tb <= art_start_date) 

new_dataTB2 <- data.frame(
  timediffTB = seq(from = -11216, to = 2139, length.out = 1000),
  id = rep(unique(tb20102022df2$id)[1], 1000)  # use the first unique id
)

model_cd4_splineTB2 <- gam(sqrt(cd4) ~ s(timediffTB) + s(id, bs="re"), data = tb20102022df2, method = "REML")
#Restricted Maximum Likelihood (REML) estimation method

# Set seed for reproducibility
set.seed(123)

# Function to fit the model and generate predictions
fit_and_predictCD42 <- function(data, indices) {
  # Fit the model with the specified indices
  fit <- gam(sqrt(cd4) ~ s(timediffTB) + s(id, bs="re"), data = data[indices, ], method = "REML")
  
  # Generate predictions
  pred <- predict(fit, newdata = new_dataTB2)
  
  return(pred)
}

# Bootstrap predictions
boot_preds.cd4_splineTB2 <- boot(data = tb20102022df2, statistic = fit_and_predictCD42, R = 100)

# Calculate percentiles for prediction intervals
lower_bound.cd4_splineTB2 <- apply(boot_preds.cd4_splineTB2$t, 2, quantile, probs = 0.025)
upper_bound.cd4_splineTB2 <- apply(boot_preds.cd4_splineTB2$t, 2, quantile, probs = 0.975)
fitted.cd4_splineTB2 <- apply(boot_preds.cd4_splineTB2$t, 2, mean)

# Combine into a data frame
boot_df.cd4_splineTB2 <- data.frame(timediffTB = new_dataTB2$timediffTB, lower_bound.cd4_splineTB2, upper_bound.cd4_splineTB2, fitted.cd4_splineTB2)

## Plot 

cd4_yearFITTB2 <- boot_df.cd4_splineTB2 %>%
  ggplot(aes(x = timediffTB)) +
  geom_hline(yintercept = sqrt(350)) +
  geom_vline(xintercept = 0, linetype = "dashed")+
  geom_line(aes(y = fitted.cd4_splineTB2), color = "blue") +
  geom_ribbon(aes(ymin = lower_bound.cd4_splineTB2, ymax = upper_bound.cd4_splineTB2), alpha = 0.2, fill = "blue") +
  geom_line(data = tb20102022df2, aes(x = timediffTB, y = sqrt(cd4), group = factor(id)), linewidth = .8, show.legend = FALSE, alpha = .2, color = "grey") +
  geom_point(data = tb20102022df2, aes(x = timediffTB, y = sqrt(cd4), group = factor(id)), size = .8, show.legend = FALSE, alpha = .2, color = "grey") +
  theme_bw()+
  labs(x = "Days from TB date", y = "Square root of CD4 count")+
  scale_x_continuous(expand = c(0,0))

print(cd4_yearFITTB2)

## RNA
model_rna_splineTB2 <- gam(log10(rna+1) ~ s(timediffTB) + s(id, bs="re"), data = tb20102022df2, method = "REML")
#Restricted Maximum Likelihood (REML) estimation method

# Set seed for reproducibility
set.seed(123)

# Function to fit the model and generate predictions
fit_and_predictRNA2 <- function(data, indices) {
  # Fit the model with the specified indices
  fit <- gam(log10(rna+1) ~ s(timediffTB) + s(id, bs="re"), data = data[indices, ], method = "REML")
  
  # Generate predictions
  pred <- predict(fit, newdata = new_dataTB2)
  
  return(pred)
}

# Bootstrap predictions
boot_preds.rna_splineTB2 <- boot(data = tb20102022df2, statistic = fit_and_predictRNA2, R = 100)

# Calculate percentiles for prediction intervals
lower_bound.rna_splineTB2 <- apply(boot_preds.rna_splineTB2$t, 2, quantile, probs = 0.025)
upper_bound.rna_splineTB2 <- apply(boot_preds.rna_splineTB2$t, 2, quantile, probs = 0.975)
fitted.rna_splineTB2 <- apply(boot_preds.rna_splineTB2$t, 2, mean)

# Combine into a data frame
boot_df.rna_splineTB2 <- data.frame(timediffTB = new_dataTB2$timediffTB, lower_bound.rna_splineTB2, upper_bound.rna_splineTB2, fitted.rna_splineTB2)

## Plot 

rna_yearFITTB2 <- boot_df.rna_splineTB2 %>%
  ggplot(aes(x = timediffTB)) +
  geom_hline(yintercept = log10(400)) +
  geom_vline(xintercept = 0, linetype = "dashed")+
  geom_line(aes(y = fitted.rna_splineTB2), color = "blue") +
  geom_ribbon(aes(ymin = lower_bound.rna_splineTB2, ymax = upper_bound.rna_splineTB2), alpha = 0.2, fill = "blue") +
  geom_line(data = tb20102022df2, aes(x = timediffTB, y = log10(rna), group = factor(id), ), linewidth = .8, show.legend = FALSE, alpha = .2, color = "grey") +
  geom_point(data = tb20102022df2, aes(x = timediffTB, y = log10(rna), group = factor(id)), size = .8, show.legend = FALSE, alpha = .2, color = "grey") +
  theme_bw()+
  labs(x = "Days from TB date", y = "Log10 of viral load")+
  scale_x_continuous(expand = c(0,0), limits = c(-7500,1000))

print(rna_yearFITTB2)

#### inspecting ids that are suspect

TB_plotTBzero <- grid.arrange(cd4_yearFITTB2, rna_yearFITTB2, ncol = 2,
                              top = "Before starting ART")

ggsave(plot = TB_plotTBzero, filename = "../results/plots_lab/TBTBzero.png", width = width_descr*2, height = height_descr)


```

```{r trends before after}
lab_longTBdate <- tb20102022long %>% 
  filter(!is.na(date_tb)) %>% 
  mutate(prevalence = if_else(date_tb < art_start_date + 60, TRUE, FALSE),
         timediffTB = as.numeric(labdate - date_tb)) %>% 
  filter(timediffTB > -360, timediffTB < 360) 

count_nonNA <- lab_longTBdate %>% 
  filter(timediffTB > -100, timediffTB < 100) %>% 
  group_by(id) %>% 
  summarize(cd4 = sum(!is.na(cd4)),
            rna = sum(!is.na(rna)))

# Filter data for before and after 0 for cd4
lab_longTBdate_before.cd4 <- lab_longTBdate %>% 
  filter(timediffTB <= 0,
         !is.na(cd4)) 

lab_longTBdate_after.cd4 <- lab_longTBdate %>% 
  filter(timediffTB > 0,
         !is.na(cd4))

# Filter data for before and after 0 for rna
lab_longTBdate_before.rna <- lab_longTBdate %>% 
  filter(timediffTB <= 0,
         !is.na(rna)) 

lab_longTBdate_after.rna <- lab_longTBdate %>% 
  filter(timediffTB > 0,
        !is.na(rna))

## trends
model_cd4before<- lmer(sqrt(cd4) ~ time_diff + (1|id), data = lab_longTBdate_before.cd4)
model_cd4after<- lmer(sqrt(cd4) ~ time_diff + (1|id), data = lab_longTBdate_after.cd4)
model_rnabefore <- lmer(log10(rna+1) ~ time_diff + (1|id), data = lab_longTBdate_before.rna)
model_rnaafter <- lmer(log10(rna+1) ~ time_diff + (1|id), data = lab_longTBdate_after.rna)

new_databefore <- data.frame(
  time_diff = seq(-360, 0, length.out = 1000),
  id = rep(unique(lab_longTBdate$id)[1], 1000)  # use the first unique id
)

new_dataafter <- data.frame(
  time_diff = seq(0, 360, length.out = 1000),
  id = rep(unique(df.pred$id)[1], 1000)  # use the first unique id
)

# Bootstrap the predictions
set.seed(123)  # for reproducibility

boot_preds.cd4before <- bootMer(model_cd4before, FUN = function(.x) predict(.x, newdata = new_databefore, re.form = NA), nsim = 100)

boot_preds.cd4after <- bootMer(model_cd4after, FUN = function(.x) predict(.x, newdata = new_dataafter, re.form = NA), nsim = 100)

boot_preds.rnabefore <- bootMer(model_rnabefore, FUN = function(.x) predict(.x, newdata = new_databefore, re.form = NA), nsim = 100)

boot_preds.rnaafter <- bootMer(model_rnaafter, FUN = function(.x) predict(.x, newdata = new_dataafter, re.form = NA), nsim = 100)

# Calculate percentiles for prediction intervals
lower_bound.cd4before <- apply(boot_preds.cd4before$t, 2, quantile, probs = 0.025)
upper_bound.cd4before <- apply(boot_preds.cd4before$t, 2, quantile, probs = 0.975)
fitted.cd4before <- apply(boot_preds.cd4before$t, 2, mean)

lower_bound.cd4after <- apply(boot_preds.cd4after$t, 2, quantile, probs = 0.025)
upper_bound.cd4after <- apply(boot_preds.cd4after$t, 2, quantile, probs = 0.975)
fitted.cd4after <- apply(boot_preds.cd4after$t, 2, mean)

lower_bound.rnabefore <- apply(boot_preds.rnabefore$t, 2, quantile, probs = 0.025)
upper_bound.rnabefore <- apply(boot_preds.rnabefore$t, 2, quantile, probs = 0.975)
fitted.rnabefore <- apply(boot_preds.rnabefore$t, 2, mean)

lower_bound.rnaafter <- apply(boot_preds.rnaafter$t, 2, quantile, probs = 0.025)
upper_bound.rnaafter <- apply(boot_preds.rnaafter$t, 2, quantile, probs = 0.975)
fitted.rnaafter <- apply(boot_preds.rnaafter$t, 2, mean)

# Combine into a data frame
boot_df.cd4before <- data.frame(time_diff = new_databefore$time_diff, lower_bound.cd4before, upper_bound.cd4before, fitted.cd4before)

boot_df.cd4after <- data.frame(time_diff = new_dataafter$time_diff, lower_bound.cd4after, upper_bound.cd4after, fitted.cd4after)

boot_df.rnabefore <- data.frame(time_diff = new_databefore$time_diff, lower_bound.rnabefore, upper_bound.rnabefore, fitted.rnabefore)

boot_df.rnaafter <- data.frame(time_diff = new_dataafter$time_diff, lower_bound.rnaafter, upper_bound.rnaafter, fitted.rnaafter)

plot.cd4_tbbefore <- ggplot(data = lab_longTBdate_before.cd4) +
  geom_point(aes(x = timediffTB, y = sqrt(cd4), group = factor(id)), color = "grey", size = .8, show.legend = FALSE) +
  geom_line(aes(x = timediffTB, y = sqrt(cd4), group = factor(id)), color = "grey", size = .8, show.legend = FALSE) +
  geom_ribbon(data = boot_df.cd4before, aes(x = time_diff, ymin = lower_bound.cd4before, ymax = upper_bound.cd4before), alpha = 0.4, fill = "blue") +
  geom_line(data = boot_df.cd4before, aes(x = time_diff, y = fitted.cd4before), color = "blue", linewidth = 1) +
  geom_hline(yintercept = sqrt(350)) +
  theme(legend.position = "none") +
  scale_x_continuous(limits = c(-360, 0), expand = c(0,0)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0,30)) +
  ylab("Square root of CD4 count") +
  xlab("")+
  theme_bw()

plot.cd4_tbbefore

plot.cd4_tbafter <- ggplot(data = lab_longTBdate_after.cd4) +
  geom_point(aes(x = timediffTB, y = sqrt(cd4), group = factor(id)), color = "grey", size = .8, show.legend = FALSE) +
  geom_line(aes(x = timediffTB, y = sqrt(cd4), group = factor(id)), color = "grey", size = .8, show.legend = FALSE) +
  geom_ribbon(data = boot_df.cd4after, aes(x = time_diff, ymin = lower_bound.cd4after, ymax = upper_bound.cd4after), alpha = 0.4, fill = "blue") +
  geom_line(data = boot_df.cd4after, aes(x = time_diff, y = fitted.cd4after), color = "blue", linewidth = 1) +
  geom_hline(yintercept = sqrt(350)) +
  theme(legend.position = "none") +
  scale_x_continuous(limits = c(0, 360), expand = c(0,0)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0,30)) +
  xlab("")+
  ylab("")+
  theme_bw()

plot.cd4_tbafter

plot.rna_tbbefore <- ggplot(data = lab_longTBdate_before.rna) +
  geom_point(aes(x = timediffTB, y = log10(rna+1), group = factor(id)), color = "grey", size = .8, show.legend = FALSE) +
  geom_line(aes(x = timediffTB, y = log10(rna+1), group = factor(id)), color = "grey", size = .8, show.legend = FALSE) +
  geom_ribbon(data = boot_df.rnabefore, aes(x = time_diff, ymin = lower_bound.rnabefore, ymax = upper_bound.rnabefore), alpha = 0.4, fill = "blue") +
  geom_line(data = boot_df.rnabefore, aes(x = time_diff, y = fitted.rnabefore), color = "blue", linewidth = 1) +
  geom_hline(yintercept = log10(400)) +
  theme(legend.position = "none") +
  scale_x_continuous(limits = c(-360, 0), expand = c(0,0)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0,8)) +
  xlab("Days to TB date") +
  ylab("Log10 of viral load") +
  theme_bw()
plot.rna_tbefore

plot.rna_tbafter <- ggplot(data = lab_longTBdate_after.rna) +
  geom_point(aes(x = timediffTB, y = log10(rna+1), group = factor(id)), color = "grey", size = .8, show.legend = FALSE) +
  geom_line(aes(x = timediffTB, y = log10(rna+1), group = factor(id)), color = "grey", size = .8, show.legend = FALSE) +
  geom_ribbon(data = boot_df.rnaafter, aes(x = time_diff, ymin = lower_bound.rnaafter, ymax = upper_bound.rnaafter), alpha = 0.4, fill = "blue") +
  geom_line(data = boot_df.rnaafter, aes(x = time_diff, y = fitted.rnaafter), color = "blue", linewidth = 1) +
  geom_hline(yintercept = log10(400)) +
  theme(legend.position = "none") +
  scale_x_continuous(limits = c(0, 360), expand = c(0,0)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0,8)) +
  xlab("Days to TB date") +
  ylab("")+
  theme_bw()

plot.rna_tbafter


tbtrend.presenting <- grid.arrange(plot.cd4_tbbefore, plot.cd4_tbafter, plot.rna_tbbefore, plot.rna_tbafter, ncol=2 ,top = "Lab data with seperately fitted linear-mixed model before and after TB diagnosis") 

ggsave(plot = tbtrend.presenting, filename = "../results/plots_lab/tbtrend.presenting.png", width = width_descr*3, height = height_descr*2)



```

```{r incidence suppression}
tb20102022long <- readRDS("../data_clean/tb20102022long.rds")

beforeTB <- tb20102022long %>% 
  filter(labdate < date_tb) %>% 
  dplyr::arrange(id,labdate)

afterTB <- tb20102022long %>% 
  filter(labdate >= date_tb) %>% 
  dplyr::arrange(id,labdate)

rna_supression_treshold <- 400
cd4_suppression_treshold <- 350

# Creating the next_rna_value and next_cd4_value columns
beforeNext <- beforeTB %>% 
  group_by(id) %>% 
  mutate(next_rna = lead(rna, order_by = labdate), #?lead: find the next value in a vector
         next_cd4 = lead(cd4, order_by = labdate))

afterNext <- afterTB %>% 
  group_by(id) %>% 
  mutate(next_rna = lead(rna, order_by = labdate), #?lead: find the next value in a vector
         next_cd4 = lead(cd4, order_by = labdate))

# Filter the rows where both the current and next rna_value are >400 and cd4_value are <350
non_suppression_before <- beforeNext %>%
  group_by(id) %>%
  filter(rna > rna_supression_treshold & next_rna > rna_supression_treshold & cd4 < cd4_suppression_treshold & next_cd4 < cd4_suppression_treshold) %>%
  slice_min(labdate, n = 1) %>% #only one incidence possible per person
  dplyr::select(id, labdate)

non_suppression_after<- afterNext %>%
  group_by(id) %>%
  filter(rna > rna_supression_treshold & next_rna > rna_supression_treshold & cd4 < cd4_suppression_treshold & next_cd4 < cd4_suppression_treshold) %>%
  slice_min(labdate, n = 1) %>% 
  dplyr::select(id, labdate)

suppression_before <- beforeNext %>%
  group_by(id) %>%
  filter(rna < rna_supression_treshold & next_rna < rna_supression_treshold & cd4 > cd4_suppression_treshold & next_cd4 > cd4_suppression_treshold) %>%
  slice_min(labdate, n = 1) %>% 
  dplyr::select(id, labdate)

suppression_after <- afterNext %>%
  group_by(id) %>%
  filter(rna < rna_supression_treshold & next_rna < rna_supression_treshold & cd4 > cd4_suppression_treshold & next_cd4 > cd4_suppression_treshold) %>%
  slice_min(labdate, n = 1) %>% 
  dplyr::select(id, labdate)

# Joining the suppression_dates with hiv
nonsup_before <- left_join(tb20102022_ch, non_suppression_before, by = "id") %>% 
  rename(viral_non_suppression = labdate)

nonsup_after <- left_join(tb20102022_ch, non_suppression_after, by = "id") %>% 
  rename(viral_non_suppression = labdate)

sup_before <- left_join(tb20102022_ch, suppression_before, by = "id") %>% 
  rename(viral_suppression = labdate)

sup_after <- left_join(tb20102022_ch, suppression_after, by = "id") %>% 
  rename(viral_suppression = labdate)

viral_non_supBefore <- nonsup_before %>%
  select(id, viral_non_suppression, art_start_date, exitdate) %>% 
  mutate(persontime = ifelse(!is.na(viral_non_suppression),
                            as.numeric(difftime(viral_non_suppression, art_start_date, units = "days")) / 360,
                            ifelse(!is.na(exitdate),
                                    as.numeric(difftime(exitdate, art_start_date, units = "days")) / 360,  
                                    as.numeric(difftime(as.Date("2022-12-31"), art_start_date, units = "days")) /360  
                             ))) %>% 
  summarise(sup_incidence = sum(!is.na(viral_non_suppression)), 
            person_years = sum(persontime)/1000) %>% 
  mutate(pois = pois.exact(x = sup_incidence, pt = person_years, conf.level = 0.95), type = as.factor("before TB"))

viral_non_supAfter <- nonsup_after %>%
  select(id, viral_non_suppression, art_start_date, exitdate) %>% 
  mutate(persontime = ifelse(!is.na(viral_non_suppression),
                            as.numeric(difftime(viral_non_suppression, art_start_date, units = "days")) / 360,
                            ifelse(!is.na(exitdate),
                                    as.numeric(difftime(exitdate, art_start_date, units = "days")) / 360,  
                                    as.numeric(difftime(as.Date("2022-12-31"), art_start_date, units = "days")) /360  
                             ))) %>% 
  summarise(sup_incidence = sum(!is.na(viral_non_suppression)), 
            person_years = sum(persontime)/1000) %>% 
  mutate(pois = pois.exact(x = sup_incidence, pt = person_years, conf.level = 0.95), type = as.factor("after TB"))

viral_supBefore <- sup_before %>%
  select(id, viral_suppression, art_start_date, exitdate) %>% 
  mutate(persontime = ifelse(!is.na(viral_suppression),
                            as.numeric(difftime(viral_suppression, art_start_date, units = "days")) / 360,
                            ifelse(!is.na(exitdate),
                                    as.numeric(difftime(exitdate, art_start_date, units = "days")) / 360,  
                                    as.numeric(difftime(as.Date("2022-12-31"), art_start_date, units = "days")) /360  
                             ))) %>% 
  summarise(sup_incidence = sum(!is.na(viral_suppression)), 
            person_years = sum(persontime)/1000) %>% 
  mutate(pois = pois.exact(x = sup_incidence, pt = person_years, conf.level = 0.95), type = as.factor("before TB"))

viral_supAfter <- sup_after %>%
  select(id, viral_suppression, art_start_date, exitdate) %>% 
  mutate(persontime = ifelse(!is.na(viral_suppression),
                            as.numeric(difftime(viral_suppression, art_start_date, units = "days")) / 360,
                            ifelse(!is.na(exitdate),
                                    as.numeric(difftime(exitdate, art_start_date, units = "days")) / 360,  
                                    as.numeric(difftime(as.Date("2022-12-31"), art_start_date, units = "days")) /360  
                             ))) %>% 
  summarise(sup_incidence = sum(!is.na(viral_suppression)), 
            person_years = sum(persontime)/1000) %>% 
  mutate(pois = pois.exact(x = sup_incidence, pt = person_years, conf.level = 0.95), type = as.factor("after TB"))

df_viralsup <- rbind(viral_supBefore, viral_supAfter)
df_viralnonsup<- rbind(viral_non_supBefore, viral_non_supAfter)

incidence_sup <- df_viralsup %>% 
  ggplot() +
  geom_point(aes(x = type, y = pois$rate)) +
  geom_errorbar(aes(x= type, ymin = pois$lower, ymax = pois$upper), width = 0.1)+
  labs(x= "", y = "Incidence per 1,000 person-years", title = "Virally suppressed") +
  theme_bw() +
    theme(plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(limits = c(0,200), expand = c(0,0))

incidence_sup  
  
incidence_nonsup <- df_viralnonsup %>% 
  ggplot() +
  geom_point(aes(x = type, y = pois$rate)) +
  geom_errorbar(aes(x= type, ymin = pois$lower, ymax = pois$upper), width = 0.1)+
  labs(x= "", y = "", title = "Virally non-suppressed") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(limits = c(0,200), expand = c(0,0))

incidence_nonsup

incidenceviral <- grid.arrange(incidence_sup, incidence_nonsup, ncol=2)

ggsave(plot = incidenceviral, filename = "../results/plots_lab/incidenceviral.png", width = width_descr*1.5, height = height_descr)

```

```{r}
presenting

PCA_incident <- incident %>% 
  dplyr::select(id: tb_regimen) %>% 
  filter(!is.na(tb_diag_rna))




```
