---
title: "Data exploration"
author: "Remo Schmutz"
date: "2023-05-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This document summarizes the data exploration and is intended to serve as an overview of the Swiss cohort data.

## Libraries

```{r}
if(!require(pacman)) install.packages("pacman")

pacman:: p_load(
  haven,
  janitor,
  inspectdf,
  flextable,
  epitools,
  rayshader,#3dplot
  htmlwidgets,#3dplot
  rgl,#3dplot
  lme4,
  merTools, #CI for multilevel
  gridExtra,
  tidyverse
  )

width_descr <- 11 / cm(1)
height_descr <- 8 / cm(1)
```

## Data

```{r}
ch <- readRDS("../data_clean/art_lab_ch.rds")
ch_lab_long <- readRDS("../data_clean/art_lab_ch_long.rds")
presentingTB_ch <- readRDS("../data_clean/presentingTB_ch.rds")
notpresentingTB_ch <- readRDS("../data_clean/notpresentingTB_ch.rds")
tb20102022_ch <- readRDS("../data_clean/tb20102022_ch.rds")
```

## Exploration of the study population (Table 1)

```{r}
##define functions

###age
calculate_age_quantiles <- function(data) {
  data %>% 
    mutate(age_at_ART_start = year(art_start_date)-born) %>% 
    summarize("25quantil" = quantile(age_at_ART_start, 0.25),
              "50quantil" = quantile(age_at_ART_start, 0.5),
              "75quantil" = quantile(age_at_ART_start, 0.75))
}

##baseline cd4 count
calculate_cd4_baseline <- function(data) {
 
  cd4_quantiles <- quantile(data$cd4_baseline, c(0.25, 0.5, 0.75), na.rm = TRUE)
  not_na_count <- sum(!is.na(data$cd4_baseline))
  min_cd4 <- min(data$cd4_baseline, na.rm = TRUE)
  max_cd4 <- max(data$cd4_baseline, na.rm = TRUE)

  list(data = data, quantiles = cd4_quantiles, not_na_count = not_na_count, min = min_cd4, max = max_cd4)
}

##baseline hiv-rna count
calculate_rna_baseline <- function(data) {
  
  rna_quantiles <- quantile(data$rna_baseline, c(0.25, 0.5, 0.75), na.rm = TRUE)
  not_na_count <- sum(!is.na(data$rna_baseline))
  min <- min(data$rna_baseline, na.rm = TRUE)
  max <- max(data$rna_baseline, na.rm = TRUE)
  list(data = data, quantiles = rna_quantiles, not_na_count = not_na_count, min = min, max = max)
}# i filter the ones out which are out of the timeframe and those with NA, this gives some more valus. For some, the most recent value may be a NA but there are other measures.

#question: there are several patients with rna = 0. Is this possible or NA?

# Complete study population
age_at_ART_start_hiv <- calculate_age_quantiles(ch)
gender_proportions_hiv <- tabyl(ch, sex)
typetb_hiv <- tabyl(ch, type_tb_shcs)
source_hiv <- tabyl(ch, risk2)
cd4_baseline_hiv <- calculate_cd4_baseline(ch)
rna_baseline_hiv <- calculate_rna_baseline(ch)
who_stages_hiv <- tabyl(ch,who_stage)

# TB study population
age_at_ART_start_tb <- calculate_age_quantiles(presentingTB_ch)
gender_proportions_tb <- tabyl(presentingTB_ch, sex)
typetb_tb <- tabyl(presentingTB_ch, type_tb_shcs)
source_hiv_tb <- tabyl(presentingTB_ch, risk2)
cd4_baseline_tb <- calculate_cd4_baseline(presentingTB_ch)
rna_baseline_tb <- calculate_rna_baseline(presentingTB_ch)
who_stages_tb <- tabyl(presentingTB_ch, who_stage)

# Not TB study population
age_at_ART_start_notb <- calculate_age_quantiles(notpresentingTB_ch)
gender_proportions_notb <- tabyl(notpresentingTB_ch, sex)
typetb_notb <- tabyl(notpresentingTB_ch, type_tb_shcs)
source_hiv_notb <- tabyl(notpresentingTB_ch, risk2)
cd4_baseline_notb <- calculate_cd4_baseline(notpresentingTB_ch)
rna_baseline_notb <- calculate_rna_baseline(notpresentingTB_ch)
who_stages_notb <- tabyl(notpresentingTB_ch, who_stage)

#### Plots
###Baseline CD4/RNA
# Calculate the counts
ch_counts <-  ch %>%
  group_by(cd4_group, rna_group) %>%
  summarise(n = n())

# Plot the data
plot_baseline_groups_ch <- ggplot(ch_counts, aes(x = cd4_group, y = rna_group, fill = n)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "steelblue") +
  labs(x = "CD4 Group",
       y = "RNA Group",
       fill = "Count",
       title = "Number of IDs per Group") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

plot_baseline_groups_ch

ggsave(filename = "../results/baseline_groups_ch.jpeg", plot = plot_baseline_groups_ch, width = 10, height = 8, dpi = 300)

#pp <- ch %>%  
 # ggplot(aes(x=sqrt(cd4_baseline), y=log10(rna_baseline))) +
  #geom_hex(bins = 20, linewidth = 0.5, color = "black") +
  #scale_fill_viridis_c(option = "C")

#plot_gg(pp, width = 4, height = 4, scale = 300, multicore = TRUE)
#widget = rglwidget()

#saveWidget(widget, file = "../results/3dplotbaseline.html")

###Source of infection / sex

infectionsex_ch <- ch %>% 
  group_by(sex,risk2) %>% 
  summarise(n = n())

# Replace the levels of sex

plot_infection_sex_ch <- infectionsex_ch %>%
  ggplot(aes(x = risk2, y = n, fill = sex)) +
  geom_col(position = "dodge") +
  labs(fill = "Sex", x = "", y = "n") +
  coord_flip() +
  ggtitle("Source of original infection") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

plot_infection_sex_ch

ggsave(filename = "../results/infectionsource.jpeg", plot = plot_infection_sex_ch, width = 10, height = 8, dpi = 300)
```

## Exploration of the TB study population (Table 2)

```{r}
#age group
custom_breaks <- c(16, 24, 34, 44, 100)

tb20102022_ch <- tb20102022_ch %>% 
  mutate(age_tb = year(date_tb) - born) %>%
  mutate(agegroups = cut(age_tb, breaks = custom_breaks, include.lowest = TRUE)) %>% 
  mutate(agegroups = as.factor(agegroups))

flextable(tabyl(tb20102022_ch, agegroups))

tb20102022_ch %>%
    summarize("25quantil" = quantile(age_tb, 0.25),
              "50quantil" = quantile(age_tb, 0.5),
              "75quantil" = quantile(age_tb, 0.75))

#gender
flextable(tabyl(tb20102022_ch, sex))

#birth country
labelled_tb.df <- as_factor(tb20102022_ch, levels="labels")
tabyl(labelled_tb.df$tbd_pat_birth)

## Define a function to map countries to continents
get_continent <- function(country) {
  africa_countries <- c("Algeria", "Angola", "Cameroon", "CÃ´te dIvoire", "Ethiopia", "Eritrea", "Gambia", "Ghana",
                        "Guinea", "Kenya", "Kongo (Brazzaville)", "Kongo (Kinshasa)", "Mauritania", "Nigeria",
                        "Somalia", "South Africa", "Togo", "Zimbabwe", "Uganda")

  if (country %in% africa_countries) {
    return("Sub-Saharan Africa")
  } else if (country %in% c("Egypt", "Morocco")) {
    return("North Africa")
  } else if (country %in% c("Russia", "Austria", "Romania", "Italy", "Spain", "Portugal", "Switzerland", "Russian Federation")) {
    return("Europe")
  } else if (country %in% c("United States", "Canada")) {
    return("North America")
  } else if (country %in% c("Argentina", "Chile", "Brasil", "Peru", "Bolivia")) {
    return("South America")
  } else if (country %in% c("Thailand", "Indonesia", "Cambodia", "Vietnam")) {
    return("Asia")
  }
  else {
    return("Unknown")
  } 
}

## Use mutate to create the 'region_born' column
result_region <- labelled_tb.df %>%
  mutate(region_born = sapply(tbd_pat_birth, get_continent),
         region_born = ifelse(id == 54167, "Sub-Saharan Africa", region_born),
         region_born = ifelse(id %in% c(59032,90323), "Asia", region_born))

#site of tb
flextable(tabyl(tb20102022_ch, type_tb_shcs)) #TBC = Pulmonary

#cd4 at tb diagnosis
tb20102022_ch %>% 
  summarize("25quantil" = quantile(tb_diag_cd4, 0.25, na.rm = TRUE),
              "50quantil" = quantile(tb_diag_cd4, 0.5, na.rm = TRUE),
              "75quantil" = quantile(tb_diag_cd4, 0.75, na.rm = TRUE),
            "missing" = sum(is.na(tb_diag_cd4)),
            "non-missing" = sum(!is.na(tb_diag_cd4)))


#hiv rna at tb diagnosis
tb20102022_ch %>% 
  summarize("25quantil" = quantile(tb_diag_rna, 0.25, na.rm = TRUE),
              "50quantil" = quantile(tb_diag_rna, 0.5, na.rm = TRUE),
              "75quantil" = quantile(tb_diag_rna, 0.75, na.rm = TRUE),
            "missing" = sum(is.na(tb_diag_rna)),
            "non-missing" = sum(!is.na(tb_diag_rna)))

#### Plots

valid_regions <- tb20102022_ch %>%
  group_by(region, agegroups) %>%
  summarise(n = n(), .groups = 'drop') %>%
  filter(n > 0) %>%
  dplyr::select(region) %>% 
  distinct()  # To ensure we don't have duplicate regions

# Create the complete data frame and filter for valid regions
region_ch <- tb20102022_ch %>%
  group_by(region, agegroups) %>%
  summarise(n = n(), .groups = 'drop') %>%
  complete(region, agegroups, fill = list(n = 0)) %>%
  filter(region %in% valid_regions$region) 

plot_region_age_ch <- region_ch %>%
  ggplot(aes(x = region, y = n, fill = factor(agegroups))) +
  geom_col(position = "dodge") +
  labs(fill = "Age group", x = "", y = "n") +
  coord_flip() +
  scale_fill_discrete(breaks = rev(levels(region_ch$agegroups))) +  # reversing the order of legend
  ggtitle("Nationality and age") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

plot_region_age_ch

ggsave(filename = "../results/nationalityage_ch.jpeg", plot = plot_region_age_ch, width = 10, height = 8, dpi = 300)
```

## Endpoints (Table 3)

Remarks: We defined incident as TB diagnosis after two months of starting ART. For this reason we'll exclude the patients with a TB case before that and begin counting the person years after the second month.

```{r}
#incidence

# Overall TB incidence rate
overall_tb_incidence <- ch %>%
  mutate(art_start_date_2m = art_start_date + months(2), 
         persontime = ifelse(case_incident_2m == 1,
                             as.numeric(difftime(date_tb, art_start_date_2m, units = "days")) / 360, #convert to years
                             ifelse(!is.na(exitdate),
                                    as.numeric(difftime(exitdate, art_start_date_2m, units = "days")) / 360,  
                                    as.numeric(difftime(as.Date("2022-12-31"), art_start_date_2m, units = "days")) /360  
                             ))) %>% 
  filter(persontime > 0) %>%
  summarise(tb_incidence = sum(case_incident_2m == 1), 
            person_years = sum(persontime)/100000) %>% 
  mutate(pois = pois.exact(x = tb_incidence, pt = person_years, conf.level = 0.95)) 

# Incidence calculations by each rna_group
incidence_by_rna <- ch %>%
  mutate(art_start_date_2m = art_start_date + months(2), 
         persontime = ifelse(case_incident_2m == 1,
                             as.numeric(difftime(date_tb, art_start_date_2m, units = "days")) / 360, 
                             ifelse(!is.na(exitdate),
                                    as.numeric(difftime(exitdate, art_start_date_2m, units = "days")) / 360,  
                                    as.numeric(difftime(as.Date("2022-12-31"), art_start_date_2m, units = "days")) /360  
                             ))) %>% 
  filter(persontime > 0) %>%
  group_by(rna_group) %>%
  summarise(tb_incidence = sum(case_incident_2m == 1), 
            person_years = sum(persontime)/100000) %>% 
  mutate(pois = pois.exact(x = tb_incidence, pt = person_years, conf.level = 0.95))

# Incidence calculations by each cd4_group
incidence_by_cd4 <- ch %>%
  mutate(art_start_date_2m = art_start_date + months(2), 
         persontime = ifelse(case_incident_2m == 1,
                             as.numeric(difftime(date_tb, art_start_date_2m, units = "days")) / 360, 
                             ifelse(!is.na(exitdate),
                                    as.numeric(difftime(exitdate, art_start_date_2m, units = "days")) / 360,  
                                    as.numeric(difftime(as.Date("2022-12-31"), art_start_date_2m, units = "days")) /360  
                             ))) %>% 
  filter(persontime > 0) %>%
  group_by(cd4_group) %>%
  summarise(tb_incidence = sum(case_incident_2m == 1), 
            person_years = sum(persontime)/100000) %>% 
  mutate(pois = pois.exact(x = tb_incidence, pt = person_years, conf.level = 0.95))

#cd4plot

incidence_cd4 <- incidence_by_cd4 %>% 
  ggplot() +
  geom_point(aes(x = cd4_group, y = pois$rate)) +
  geom_errorbar(aes(x= cd4_group, ymin = pois$lower, ymax = pois$upper), width = 0.2) +
  geom_point(aes(x = "overall", y=overall_tb_incidence$pois$rate)) +
  geom_errorbar(aes(x= "overall", ymin = overall_tb_incidence$pois$lower, 
                    ymax = overall_tb_incidence$pois$upper), width = 0.2) +
  labs(x= "Baseline CD4 cell count", y = "TB incidence per 100,000 person-years") +
  theme_bw()
incidence_cd4

ggsave(plot = incidence_cd4, filename = "../results/incidence_cd4.png", width = width_descr, height = height_descr)

#rnaplot

incidence_rna <- incidence_by_rna %>% 
  ggplot() +
  geom_point(aes(x = rna_group, y = pois$rate)) +
  geom_errorbar(aes(x= rna_group, ymin = pois$lower, ymax = pois$upper), width = 0.2) +
  geom_point(aes(x = "overall", y=overall_tb_incidence$pois$rate)) +
  geom_errorbar(aes(x= "overall", ymin = overall_tb_incidence$pois$lower, 
                    ymax = overall_tb_incidence$pois$upper), width = 0.2) +
  labs(x= "Baseline HIV RNA viral load", y = "TB incidence per 100,000 person-years") +
  theme_bw()

incidence_rna

ggsave(plot = incidence_rna, filename = "../results/incidence_rna.png", width = width_descr, height = height_descr)

#time to tb
time_to_tb <- ch %>% 
  filter(case_incident_2m ==1) %>% 
  mutate(time_to_tb = as.numeric(date_tb - (art_start_date + months(2)))) %>% 
  summarise(median = median(time_to_tb, na.rm = TRUE),
            "25%" = quantile(time_to_tb, 0.25, na.rm = TRUE),
            "75%" = quantile(time_to_tb, 0.75, na.rm = TRUE))

#incidence of viral non-suppression
rna_supression_treshold <- 400
cd4_suppression_treshold <- 350

# Sorting the data by id and date
lab_long <- ch_lab_long %>% arrange(id, labdate) %>% 
  filter(labdate > art_start_date)

# Creating the next_rna_value and next_cd4_value columns
lab_long_next <- lab_long %>% 
  group_by(id) %>% 
  mutate(next_rna = lead(rna, order_by = labdate), #?lead: find the next value in a vector
         next_cd4 = lead(cd4, order_by = labdate))

# Filter the rows where both the current and next rna_value are >400 and cd4_value are <350
non_suppression_dates <- lab_long_next %>%
  group_by(id) %>%
  filter(rna > rna_supression_treshold & next_rna > rna_supression_treshold & cd4 < cd4_suppression_treshold & next_cd4 < cd4_suppression_treshold) %>%
  slice_min(labdate, n = 1) %>% 
  dplyr::select(id, labdate)

suppression_dates <- lab_long_next %>%
  group_by(id) %>%
  filter(rna < rna_supression_treshold & next_rna < rna_supression_treshold & cd4 > cd4_suppression_treshold & next_cd4 > cd4_suppression_treshold) %>%
  slice_min(labdate, n = 1) %>% 
  dplyr::select(id, labdate)

# Joining the suppression_dates with hiv
hiv_nonsup <- left_join(ch, non_suppression_dates, by = "id") %>% 
  rename(viral_non_suppression = labdate)

hiv_sup <- left_join(ch, suppression_dates, by = "id") %>% 
  rename(viral_suppression = labdate)

viral_non_suppression_incidence <- hiv_nonsup %>%
  select(id, viral_non_suppression, art_start_date, exitdate) %>% 
  mutate(persontime = ifelse(!is.na(viral_non_suppression),
                            as.numeric(difftime(viral_non_suppression, art_start_date, units = "days")) / 360,
                            ifelse(!is.na(exitdate),
                                    as.numeric(difftime(exitdate, art_start_date, units = "days")) / 360,  
                                    as.numeric(difftime(as.Date("2022-12-31"), art_start_date, units = "days")) /360  
                             ))) %>% 
  summarise(sup_incidence = sum(!is.na(viral_non_suppression)), 
            person_years = sum(persontime)/1000) %>% 
  mutate(pois = pois.exact(x = sup_incidence, pt = person_years, conf.level = 0.95))

viral_suppression_incidence <- hiv_sup %>%
  select(id, viral_suppression, art_start_date, exitdate) %>% 
  mutate(persontime = ifelse(!is.na(viral_suppression),
                            as.numeric(difftime(viral_suppression, art_start_date, units = "days")) / 360,
                            ifelse(!is.na(exitdate),
                                    as.numeric(difftime(exitdate, art_start_date, units = "days")) / 360,  
                                    as.numeric(difftime(as.Date("2022-12-31"), art_start_date, units = "days")) /360  
                             ))) %>% 
  summarise(sup_incidence = sum(!is.na(viral_suppression)), 
            person_years = sum(persontime)/1000) %>% 
  mutate(pois = pois.exact(x = sup_incidence, pt = person_years, conf.level = 0.95))
#time to viral suppression

time_to_virnonsup <- hiv_nonsup %>% 
  select(id, viral_non_suppression, art_start_date) %>% 
  mutate(time_to_sup = as.numeric(viral_non_suppression-art_start_date)) %>% 
  summarise(med = median(time_to_sup, na.rm = TRUE),
            "25" = quantile(time_to_sup, 0.25, na.rm = TRUE),
            "75" = quantile(time_to_sup, 0.75, na.rm = TRUE))

time_to_virsup <- hiv_sup %>% 
  select(id, viral_suppression, art_start_date) %>% 
  mutate(time_to_sup = as.numeric(viral_suppression-art_start_date)) %>% 
  summarise(med = median(time_to_sup, na.rm = TRUE),
            "25" = quantile(time_to_sup, 0.25, na.rm = TRUE),
            "75" = quantile(time_to_sup, 0.75, na.rm = TRUE))

```

```{r}
lab_distribution <- ch_lab_long %>% 
  filter(!is.na(cd4) | !is.na(rna)) %>% 
  ggplot(aes(x= time_diff)) +
  geom_histogram(fill = "darkblue") +
  labs(x="days difference from art start", title = "Distribution of non-NA lab-measurements") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) 

ggsave(plot = lab_distribution, filename = "../results/lab_distribution.png", width = width_descr, height = height_descr)
```

```{r plots for meeting}
ch_lab_long <- ch_lab_long %>%
  mutate(year = round(time_diff / 365))

ch_lab_long %>% 
  group_by(year) %>% 
  summarise(med = median(rna, na.rm = TRUE))

ch_lab_sum <- ch_lab_long %>%
  group_by(year) %>%
  mutate(rna = log10(rna + 1)) %>% 
  summarise(
    median_cd4 = median(cd4, na.rm = TRUE),
    lower_cd4 = quantile(cd4, 0.25, na.rm = TRUE),
    higher_cd4 = quantile(cd4, 0.75, na.rm = TRUE),
    mean_cd4 = mean(cd4, na.rm = TRUE),
    median_rna = median(rna, na.rm = TRUE),
    lower_rna = quantile(rna,0.25, na.rm = TRUE),    
    higher_rna = quantile(rna, 0.75, na.rm =TRUE),
    mean_rna = mean(rna, na.rm = TRUE)
  )

## cd4 over years
cd4_quantile <- ch_lab_long %>% 
  ggplot(aes(x= year)) +
  geom_line(aes(group = factor(id), y = cd4), color = "grey", alpha = .5)+
  geom_line(data= ch_lab_sum,
            aes(y=mean_cd4),
            color = "darkgreen") +
  geom_errorbar(data = ch_lab_sum, 
                aes(ymin = lower_cd4, ymax = higher_cd4), 
                width = 0.2, color = "black") +
  geom_point(data = ch_lab_sum, 
             aes(y = median_cd4), 
             size = 1, color = "red")+
  geom_hline(yintercept =350) +
  theme_bw() +
  labs(x= "year difference from labdate to ART start")

cd4_quantile

ggsave(plot = cd4_quantile, filename = "../results/cd4_quantile.png", width = width_descr, height = height_descr)

## cd4 model vs observed 


### rna

rna_quantile <- ch_lab_long %>% 
  ggplot(aes(x= year)) +
  geom_line(aes(group = factor(id), y = log10(rna)), color = "grey", alpha = .5)+
  geom_line(data= ch_lab_sum,
            aes(y=mean_rna),
            color = "darkgreen") +
  geom_errorbar(data = ch_lab_sum, 
                aes(ymin = lower_rna, ymax = higher_rna), 
                width = 0.2, color = "black") +
  geom_point(data = ch_lab_sum, 
             aes(y = median_rna), 
             size = 1, color = "red")+
  theme_bw() +
  geom_hline(yintercept = log10(400)) +
  labs(x= "year difference from labdate to ART start") 

rna_quantile

ggsave(plot = rna_quantile, filename = "../results/rna_quantile.png", width = width_descr, height = height_descr)

# rna 1 year
rna_year <- ch_lab_long %>%
  filter(time_diff > -150 & time_diff < 360) %>% 
  ggplot(aes(x = time_diff)) +
  geom_line(aes(group = factor(id), y = log10(rna)), color = "grey", alpha = .5) +
  geom_smooth(aes(y = log10(rna)), method = "lm", color = "red", se = FALSE)+
  geom_hline(yintercept = log10(400)) +
  labs(x = "Days since ART start") +
  theme_bw()

ggsave(plot = rna_year, filename = "../results/rna_year.png", width = width_descr, height = height_descr)

# checking the weird shape of the rna plot
zero_rna <- ch_lab_long %>% 
  group_by(year) %>% 
  summarise(zero_rna = sum(rna == 0, na.rm = TRUE), non_zero = sum(rna != 0, na.rm = TRUE), nA = sum(is.na(rna)))

rna_measurements <- zero_rna %>% 
  ggplot(aes(x=year)) +
  geom_point(aes(y= zero_rna, color = "zero_rna"), size = 1) +
  geom_point(aes(y= non_zero, color = "non_zero"), size = 1) +
  geom_point(aes(y = nA, color = "nA"), size = 1) +
  scale_y_continuous(limits = c(0,20000)) +
  scale_color_manual(values = c("zero_rna" = "red", "non_zero" = "blue", "nA" = "grey"),
                     labels = c("zero_rna" = "rna=0", "non_zero" = "rna != 0", "nA" = "NA")) +
  guides(color = guide_legend(title = NULL)) +
  theme_bw() +
  labs(y=("number of rna measurements"), x = "year difference to ART start")

ggsave(plot = rna_measurements, filename = "../results/rna_meas.png", width = width_descr, height = height_descr)

```

```{r plot presenting with TB}
lab_longTB.cd4 <- ch_lab_long %>% 
  filter(date_tb >= art_start_date-365,
         !is.na(cd4)) %>% 
  mutate(prevalence = if_else(date_tb < art_start_date + 60, TRUE, FALSE),
         ARTtoTB = date_tb-art_start_date) %>%
  group_by(id) %>%
  mutate(min_diff_date = labdate[which.min(abs(labdate - date_tb))]) %>%
  ungroup() %>% 
  mutate(min_diff_date_days = as.numeric(min_diff_date-art_start_date),
         min_diff_date_cd4 = if_else(min_diff_date_days == time_diff, sqrt(cd4), NA_real_))

lab_longTB.rna <- ch_lab_long %>% 
  filter(date_tb >= art_start_date-365,
         !is.na(rna)) %>% 
  mutate(prevalence = if_else(date_tb < art_start_date + 60, TRUE, FALSE),
         ARTtoTB = date_tb-art_start_date,
         log10rna = log10(rna + 1)) %>%
  group_by(id) %>%
  mutate(min_diff_date = labdate[which.min(abs(labdate - date_tb))]) %>%
  ungroup() %>% 
  mutate(min_diff_date_days = as.numeric(min_diff_date-art_start_date),
         min_diff_date_rna = if_else(min_diff_date_days == time_diff, log10rna, NA_real_))

colors <- rainbow(55)

lab_longTB.rna %>% 
  group_by(id) %>% 
  summarise(sum = sum(!is.na(min_diff_date_rna)))

#cd4
plot.cd4_points <- lab_longTB.cd4 %>% 
  filter(prevalence == TRUE) %>% 
  ggplot(aes(x = time_diff, color = factor(id))) +
  geom_line(aes(group = factor(id), y = sqrt(cd4)), alpha = .5) +
  geom_point(aes(group = factor(id), y = sqrt(cd4)), alpha = .5) +
  geom_hline(yintercept = sqrt(350)) +
  geom_point(aes(x=ARTtoTB, y = min_diff_date_cd4), shape = 13, size = 3)+
  labs(x = "Days since ART start") +
ylab("Square root of CD4 count") +
  xlim(c(-360,720))+
  theme_bw() +
  theme(legend.position = "none") 

print(plot.cd4_points)

#rna
plot.rna_points <- lab_longTB.rna %>% 
  filter(prevalence == TRUE) %>% 
  ggplot(aes(x = time_diff, color = factor(id))) +
  geom_line(aes(group = factor(id), y = log10rna), alpha = .5) +
  geom_point(aes(group = factor(id), y = log10rna), alpha = .5) +
  geom_hline(yintercept = log10(400)) +
  geom_point(aes(x=ARTtoTB, y = min_diff_date_rna), shape = 13, size = 3)+
  labs(x = "Days since ART start") +
  xlim(c(-360,720))+
  ylim(c(-.5,7.5))+
  ylab(expression(log[10]("cd4"))) +
  theme_bw() +
  ylab("log10(rna+1)")+
  theme(legend.position = "none") 

print(plot.rna_points)

## saving 

points.presenting <- grid.arrange(plot.cd4_points, plot.rna_points, ncol=2, 
             top = "TB dates and lab data for 55 Patients presenting with TB") 

ggsave(plot = points.presenting, filename = "../results/plots_lab/points.presenting.png", width = width_descr*2, height = height_descr)
```

```{r plot incident cases}
#cd4

plot.cd4_pointsINC <- lab_longTB.cd4 %>% 
  filter(prevalence == FALSE) %>% 
  ggplot(aes(x = time_diff, color = factor(id))) +
  geom_line(aes(group = factor(id), y = sqrt(cd4)), alpha = .5) +
  geom_point(aes(group = factor(id), y = sqrt(cd4))) +
  geom_hline(yintercept = sqrt(350)) +
  geom_point(aes(x=ARTtoTB, y = min_diff_date_cd4), shape = 13, size = 3)+
  labs(x = "Days since ART start") +
  ylab("Square root of CD4 count") +
  theme_bw() +
  theme(legend.position = "none") +
  scale_x_continuous(limits = c(0, 3000))

print(plot.cd4_pointsINC)

#rna
plot.rna_pointsINC <- lab_longTB.rna %>% 
  filter(prevalence == FALSE) %>% 
  ggplot(aes(x = time_diff, color = factor(id))) +
  geom_line(aes(group = factor(id), y = log10rna), alpha = .5) +
  geom_point(aes(group = factor(id), y = log10rna)) +
  geom_hline(yintercept = log10(400)) +
  geom_point(aes(x = ARTtoTB, y = min_diff_date_rna), shape = 13, size = 3) +
  labs(x = "Days since ART start") +
  ylim(c(-.5, 7.5)) +
  ylab(expression(log[10]("cd4"))) +
  theme_bw() +
  ylab("log10(rna+1)") +
  theme(legend.position = "none") +
  scale_x_continuous(limits = c(0, 3000))

print(plot.rna_pointsINC)

points.presentingINC <- grid.arrange(plot.cd4_pointsINC, plot.rna_pointsINC, ncol=2, 
             top = "TB dates and lab data for 15 TB incident patients") 

ggsave(plot = points.presentingINC, filename = "../results/plots_lab/points.presentingINC.png", width = width_descr*2, height = height_descr)

```

```{r plotly}
library(plotly)

ggplotly(plot.cd4_points)
ggplotly(plot.rna_points)
ggplotly(plot.cd4_pointsINC)
ggplotly(plot.rna_pointsINC)

```

```{r}
lab_longTBdate <- ch_lab_long %>% 
  filter(!is.na(date_tb)) %>% 
  mutate(prevalence = if_else(date_tb < art_start_date + 60, TRUE, FALSE),
         timediffTB = as.numeric(labdate - date_tb))

count_nonNA <- lab_longTBdate %>% 
  filter(timediffTB > -360, timediffTB < 360) %>% 
  group_by(id) %>% 
  summarize(cd4 = sum(!is.na(cd4)),
            rna = sum(!is.na(rna)))

# Filter data for before and after 0 for cd4
lab_longTBdate_before.cd4 <- lab_longTBdate %>% 
  filter(timediffTB <= 0,
         prevalence == TRUE,
         !is.na(cd4)) 

lab_longTBdate_after.cd4 <- lab_longTBdate %>% 
  filter(timediffTB > 0,
         prevalence == TRUE,
         !is.na(cd4))

# Filter data for before and after 0 for rna
lab_longTBdate_before.rna <- lab_longTBdate %>% 
  filter(timediffTB <= 0,
         prevalence == TRUE,
         !is.na(rna)) 

lab_longTBdate_after.rna <- lab_longTBdate %>% 
  filter(timediffTB > 0,
         prevalence == TRUE,
        !is.na(rna))

# cd4 prev
plot.cd4_tb <- ggplot() +
  geom_point(data = lab_longTBdate_before.cd4, aes(x = timediffTB, y = sqrt(cd4), group = factor(id), color = factor(id)), size = .8) +
  geom_point(data = lab_longTBdate_after.cd4, aes(x = timediffTB, y = sqrt(cd4), group = factor(id), color = factor(id)), size = .8) +
  geom_line(data = lab_longTBdate_before.cd4, aes(x = timediffTB, y = sqrt(cd4), group = factor(id), color = factor(id)), alpha = .5) +
  geom_line(data = lab_longTBdate_after.cd4, aes(x = timediffTB, y = sqrt(cd4), group = factor(id), color = factor(id)), alpha = .5) +
  geom_smooth(data = lab_longTBdate_before.cd4, aes(x = timediffTB, y = sqrt(cd4), group = 1), method = "lm", se = FALSE, color = "blue") +
  geom_smooth(data = lab_longTBdate_after.cd4, aes(x = timediffTB, y = sqrt(cd4), group = 1), method = "lm", se = FALSE, color = "red") +
  geom_hline(yintercept = sqrt(350)) +
  theme_bw() +
  theme(legend.position = "none") +
  scale_x_continuous(limits = c(-360, 360)) +
  xlab("Days to TB date") +
  ylab("Square root of CD4 count") 

plot.rna_tb <- ggplot() +
  geom_point(data = lab_longTBdate_before.rna, aes(x = timediffTB, y = log10(rna + 1), group = factor(id), color = factor(id)), size = .8) +
  geom_point(data = lab_longTBdate_after.rna, aes(x = timediffTB, y = log10(rna + 1), group = factor(id), color = factor(id)), size = .8) +
  geom_line(data = lab_longTBdate_before.rna, aes(x = timediffTB, y = log10(rna + 1), group = factor(id), color = factor(id)), alpha = .5) +
  geom_line(data = lab_longTBdate_after.rna, aes(x = timediffTB, y = log10(rna + 1), group = factor(id), color = factor(id)), alpha = .5) +
  geom_smooth(data = lab_longTBdate_before.rna, aes(x = timediffTB, y = log10(rna + 1), group = 1), method = "lm", se = FALSE, color = "blue") +
  geom_smooth(data = lab_longTBdate_after.rna, aes(x = timediffTB, y = log10(rna + 1), group = 1), method = "lm", se = FALSE, color = "red") +
  geom_hline(yintercept = log10(400)) +
  theme_bw() +
  theme(legend.position = "none") +
  scale_x_continuous(limits = c(-360, 360)) +
  xlab("Days to TB date") +
  ylab("log10 of viral load") 

print(plot.cd4_tb)
print(plot.rna_tb)

library(cowplot)
tbtrend.presenting <- plot_grid(plot.cd4_tb, plot.rna_tb)
print(tbtrend.presenting)

ggsave(plot = tbtrend.presenting, filename = "../results/plots_lab/tbtrend.presenting.png", width = width_descr*2, height = height_descr)
```

```{r}
tb20102022long <- readRDS("../data_clean/tb20102022long.rds")

beforeTB <- tb20102022long %>% 
  filter(labdate < date_tb) %>% 
  dplyr::arrange(id,labdate)

afterTB <- tb20102022long %>% 
  filter(labdate >= date_tb) %>% 
  dplyr::arrange(id,labdate)

rna_supression_treshold <- 400
cd4_suppression_treshold <- 350

# Creating the next_rna_value and next_cd4_value columns
beforeNext <- beforeTB %>% 
  group_by(id) %>% 
  mutate(next_rna = lead(rna, order_by = labdate), #?lead: find the next value in a vector
         next_cd4 = lead(cd4, order_by = labdate))

afterNext <- afterTB %>% 
  group_by(id) %>% 
  mutate(next_rna = lead(rna, order_by = labdate), #?lead: find the next value in a vector
         next_cd4 = lead(cd4, order_by = labdate))

# Filter the rows where both the current and next rna_value are >400 and cd4_value are <350
non_suppression_before <- beforeNext %>%
  group_by(id) %>%
  filter(rna > rna_supression_treshold & next_rna > rna_supression_treshold & cd4 < cd4_suppression_treshold & next_cd4 < cd4_suppression_treshold) %>%
  slice_min(labdate, n = 1) %>% 
  dplyr::select(id, labdate)

non_suppression_after<- afterNext %>%
  group_by(id) %>%
  filter(rna > rna_supression_treshold & next_rna > rna_supression_treshold & cd4 < cd4_suppression_treshold & next_cd4 < cd4_suppression_treshold) %>%
  slice_min(labdate, n = 1) %>% 
  dplyr::select(id, labdate)

suppression_before <- beforeNext %>%
  group_by(id) %>%
  filter(rna < rna_supression_treshold & next_rna < rna_supression_treshold & cd4 > cd4_suppression_treshold & next_cd4 > cd4_suppression_treshold) %>%
  slice_min(labdate, n = 1) %>% 
  dplyr::select(id, labdate)

suppression_after <- afterNext %>%
  group_by(id) %>%
  filter(rna < rna_supression_treshold & next_rna < rna_supression_treshold & cd4 > cd4_suppression_treshold & next_cd4 > cd4_suppression_treshold) %>%
  slice_min(labdate, n = 1) %>% 
  dplyr::select(id, labdate)

# Joining the suppression_dates with hiv
nonsup_before <- left_join(tb20102022_ch, non_suppression_before, by = "id") %>% 
  rename(viral_non_suppression = labdate)

nonsup_after <- left_join(tb20102022_ch, non_suppression_after, by = "id") %>% 
  rename(viral_non_suppression = labdate)

sup_before <- left_join(tb20102022_ch, suppression_before, by = "id") %>% 
  rename(viral_suppression = labdate)

sup_after <- left_join(tb20102022_ch, suppression_after, by = "id") %>% 
  rename(viral_suppression = labdate)

viral_non_supBefore <- nonsup_before %>%
  select(id, viral_non_suppression, art_start_date, exitdate) %>% 
  mutate(persontime = ifelse(!is.na(viral_non_suppression),
                            as.numeric(difftime(viral_non_suppression, art_start_date, units = "days")) / 360,
                            ifelse(!is.na(exitdate),
                                    as.numeric(difftime(exitdate, art_start_date, units = "days")) / 360,  
                                    as.numeric(difftime(as.Date("2022-12-31"), art_start_date, units = "days")) /360  
                             ))) %>% 
  summarise(sup_incidence = sum(!is.na(viral_non_suppression)), 
            person_years = sum(persontime)/1000) %>% 
  mutate(pois = pois.exact(x = sup_incidence, pt = person_years, conf.level = 0.95), type = as.factor("before TB"))

viral_non_supAfter <- nonsup_after %>%
  select(id, viral_non_suppression, art_start_date, exitdate) %>% 
  mutate(persontime = ifelse(!is.na(viral_non_suppression),
                            as.numeric(difftime(viral_non_suppression, art_start_date, units = "days")) / 360,
                            ifelse(!is.na(exitdate),
                                    as.numeric(difftime(exitdate, art_start_date, units = "days")) / 360,  
                                    as.numeric(difftime(as.Date("2022-12-31"), art_start_date, units = "days")) /360  
                             ))) %>% 
  summarise(sup_incidence = sum(!is.na(viral_non_suppression)), 
            person_years = sum(persontime)/1000) %>% 
  mutate(pois = pois.exact(x = sup_incidence, pt = person_years, conf.level = 0.95), type = as.factor("after TB"))

viral_supBefore <- sup_before %>%
  select(id, viral_suppression, art_start_date, exitdate) %>% 
  mutate(persontime = ifelse(!is.na(viral_suppression),
                            as.numeric(difftime(viral_suppression, art_start_date, units = "days")) / 360,
                            ifelse(!is.na(exitdate),
                                    as.numeric(difftime(exitdate, art_start_date, units = "days")) / 360,  
                                    as.numeric(difftime(as.Date("2022-12-31"), art_start_date, units = "days")) /360  
                             ))) %>% 
  summarise(sup_incidence = sum(!is.na(viral_suppression)), 
            person_years = sum(persontime)/1000) %>% 
  mutate(pois = pois.exact(x = sup_incidence, pt = person_years, conf.level = 0.95), type = as.factor("before TB"))

viral_supAfter <- sup_after %>%
  select(id, viral_suppression, art_start_date, exitdate) %>% 
  mutate(persontime = ifelse(!is.na(viral_suppression),
                            as.numeric(difftime(viral_suppression, art_start_date, units = "days")) / 360,
                            ifelse(!is.na(exitdate),
                                    as.numeric(difftime(exitdate, art_start_date, units = "days")) / 360,  
                                    as.numeric(difftime(as.Date("2022-12-31"), art_start_date, units = "days")) /360  
                             ))) %>% 
  summarise(sup_incidence = sum(!is.na(viral_suppression)), 
            person_years = sum(persontime)/1000) %>% 
  mutate(pois = pois.exact(x = sup_incidence, pt = person_years, conf.level = 0.95), type = as.factor("after TB"))

df_viralsup <- rbind(viral_supBefore, viral_supAfter)
df_viralnonsup<- rbind(viral_non_supBefore, viral_non_supAfter)

incidence_sup <- df_viralsup %>% 
  ggplot() +
  geom_point(aes(x = type, y = pois$rate)) +
  geom_errorbar(aes(x= type, ymin = pois$lower, ymax = pois$upper), width = 0.1)+
  labs(x= "", y = "Incidence per 1,000 person-years", title = "Viral suppression") +
  theme_bw() +
    theme(plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(limits = c(0,200), expand = c(0,0))

incidence_sup  
  
incidence_nonsup <- df_viralnonsup %>% 
  ggplot() +
  geom_point(aes(x = type, y = pois$rate)) +
  geom_errorbar(aes(x= type, ymin = pois$lower, ymax = pois$upper), width = 0.1)+
  labs(x= "", y = "", title = "Viral non-suppression") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(limits = c(0,200), expand = c(0,0))

incidence_nonsup

incidenceviral <- plot_grid(incidence_sup, incidence_nonsup, ncol=2)

ggsave(plot = incidenceviral, filename = "../results/plots_lab/incidenceviral.png", width = width_descr*1.5, height = height_descr)


```
