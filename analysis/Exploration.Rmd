---
title: "Data exploration"
author: "Remo Schmutz"
date: "2023-05-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This document summarizes the data exploration and is intended to serve as an overview of the Swiss cohort data.

## Libraries

```{r}
if(!require(pacman)) install.packages("pacman")

pacman:: p_load(
  tidyverse,
  haven,
  janitor,
  inspectdf,
  flextable
)

```

## Data

```{r}
hiv <- readRDS("../data_clean/studypopulation_hiv.rds")
tb <- readRDS("../data_clean/studypopulation_tb.rds")
no_tb <- readRDS("../data_clean/studypopulation_without_tb.rds")
dis <- readRDS("../data_clean/disease.rds")
lab <- readRDS("../data_clean/laboratory.rds")
lab_long <- readRDS("../data_clean/lab_both_long.rds")
```

## Exploration of the study population (Table 1)

```{r}
##define functions

###age
calculate_age_quantiles <- function(data) {
  data %>%
    summarize("25quantil" = quantile(age_at_ART_start, 0.25),
              "50quantil" = quantile(age_at_ART_start, 0.5),
              "75quantil" = quantile(age_at_ART_start, 0.75))
}

###gender
calculate_gender_proportions <- function(data) {
  data %>%
    group_by(sex) %>%
    summarise(count = n()) %>%
    mutate(proportion = count / sum(count))
}

###type of TB
calculate_type_of_TB <- function(data) {
  data %>%
    mutate(type_tb_shcs = ifelse(type_tb_shcs == 3, 1, type_tb_shcs)) %>% # 1 and 3 are both pulmonary
    group_by(type_tb_shcs) %>%
    summarize(count = n()) %>%
    filter(!is.na(type_tb_shcs)) %>%
    mutate(proportion = count / sum(count))
}

##baseline cd4 count
calculate_cd4_baseline <- function(data, lab_data) {
  merged_data <- left_join(data, lab, by = "id") %>%
  select(id, art_start_date, cd4, labdate) %>%
  mutate(rna = ifelse(labdate >= (art_start_date - 180) & labdate <= (art_start_date + 30), cd4, NA)) %>%
  filter(!is.na(cd4)) %>% 
  arrange(abs(art_start_date - labdate)) %>%
  group_by(id) %>%
  distinct(id, .keep_all = TRUE)
  
  cd4_quantiles <- quantile(merged_data$cd4, c(0.25, 0.5, 0.75), na.rm = TRUE)
  not_na_count <- sum(!is.na(merged_data$cd4))
  list(quantiles = cd4_quantiles, not_na_count = not_na_count)

}
##baseline hiv-rna count
calculate_rna_baseline <- function(data, lab_data) {
  merged_data <- left_join(data, lab, by = "id") %>%
  select(id, art_start_date, rna, labdate) %>%
  mutate(rna = ifelse(labdate >= (art_start_date - 180) & labdate <= (art_start_date + 30), rna, NA)) %>%
  filter(!is.na(rna)) %>% 
  arrange(abs(art_start_date - labdate)) %>%
  group_by(id) %>%
  distinct(id, .keep_all = TRUE)
  
  rna_quantiles <- quantile(merged_data$rna, c(0.25, 0.5, 0.75), na.rm = TRUE)
  not_na_count <- sum(!is.na(merged_data$rna))
  list(quantiles = rna_quantiles, not_na_count = not_na_count)
}# i filter the ones out which are out of the timeframe and those with NA, this gives some more valus. For some, the most recent value may be a NA but there are other measures.

#question: there are several patients with rna = 0. Is this possible or NA?

ids_only_in_n_complete <- setdiff(hiv$id, lab$id) #35 ids don't have lab data
length(ids_only_in_n_complete)

##who clinical stage
  
calculate_who_stages <- function(data) {
  merged_data <- left_join(data, dis, by = "id") %>%
  select(id, art_start_date, newdate, disease, cdc_group) %>%
  mutate(cdc_group = ifelse(cdc_group =="", NA, cdc_group)) %>%
  group_by(id) %>%
  mutate(cdc_group =  
  ifelse(newdate <= (art_start_date + 30), cdc_group, NA)) %>%
  arrange(abs(art_start_date - newdate)) %>%
  filter(!is.na(cdc_group)) %>% 
  distinct(id, .keep_all = TRUE) %>% 
   mutate(who_stage = case_when(
     cdc_group == "A" ~ 1,
     cdc_group == "B" ~ 2.3,
     cdc_group == "C" ~ 4
   )) %>% 
   ungroup() 
  
  tabyl(merged_data, who_stage)

}

# Complete study population
age_at_ART_start_hiv <- calculate_age_quantiles(hiv)
gender_proportions_hiv <- calculate_gender_proportions(hiv)
typetb_hiv <- calculate_type_of_TB(hiv)
cd4_baseline_hiv <- calculate_cd4_baseline(hiv)
rna_baseline_hiv <- calculate_rna_baseline(hiv, lab)
who_stages_hiv <- calculate_who_stages(hiv)

# TB study population
age_at_ART_start_tb <- calculate_age_quantiles(tb)
gender_proportions_tb <- calculate_gender_proportions(tb)
typetb_tb <- calculate_type_of_TB(tb)
cd4_baseline_tb <- calculate_cd4_baseline(tb)
rna_baseline_tb <- calculate_rna_baseline(tb, lab)
who_stages_tb <- calculate_who_stages(tb)

# Not TB study population
age_at_ART_start_notb <- calculate_age_quantiles(no_tb)
gender_proportions_notb <- calculate_gender_proportions(no_tb)
cd4_baseline_notb <- calculate_cd4_baseline(no_tb)
rna_baseline_notb <- calculate_rna_baseline(no_tb, lab)
who_stages_notb <- calculate_who_stages(no_tb)
```

## Exploration of the TB study population (Table 2)

```{r}
#age group
custom_breaks <- c(16, 24, 34, 44, 100)

tb <- tb %>% 
  mutate(age_tb = year(date_tb) - born) %>%
  mutate(agegroups = cut(age_tb, breaks = custom_breaks, include.lowest = TRUE)) 

flextable(tabyl(tb, agegroups))

#gender

#birth country

flextable(tabyl(tb, tbd_pat_birth)) #140 = Switzerland

#site of tb

flextable(tabyl(tb, disease_tbc)) #TBC = Pulmonary

#cd4 at tb diagnosis
calculate_cd4_tbdiagnosis <- function(data, lab_data) {
  merged_data <- left_join(data, lab, by = "id") %>%
  select(id, date_tb, cd4, labdate) %>%
  mutate(cd4 = ifelse(labdate >= (date_tb - 30) & labdate <= (date_tb + 15), cd4, NA)) %>%
  filter(!is.na(cd4)) %>% 
  arrange(abs(date_tb - labdate)) %>%
  group_by(id) %>%
  distinct(id, .keep_all = TRUE)
  
  cd4_quantiles <- quantile(merged_data$cd4, c(0.25, 0.5, 0.75), na.rm = TRUE)
  not_na_count <- sum(!is.na(merged_data$cd4))
  list(quantiles = cd4_quantiles, not_na_count = not_na_count)

}

cd4_tbdiagnosis <- calculate_cd4_tbdiagnosis(tb, lab)

#hiv rna at tb diagnosis
calculate_rna_tbdiagnosis <- function(data, lab_data) {
  merged_data <- left_join(data, lab, by = "id") %>%
  select(id, date_tb, rna, labdate) %>%
  mutate(rna = ifelse(labdate >= (date_tb - 30) & labdate <= (date_tb + 15), rna, NA)) %>%
  filter(!is.na(rna)) %>% 
  arrange(abs(date_tb - labdate)) %>%
  group_by(id) %>%
  distinct(id, .keep_all = TRUE)
  
  rna_quantiles <- quantile(merged_data$rna, c(0.25, 0.5, 0.75), na.rm = TRUE)
  not_na_count <- sum(!is.na(merged_data$rna))
  list(quantiles = rna_quantiles, not_na_count = not_na_count)
  
}

rna_tbdiagnosis <- calculate_rna_tbdiagnosis(tb, lab)
```

## Endpoints (Table 3)

Remarks: We defined incident as TB diagnosis after two months of starting ART. For this reason we'll exclude the patients with a TB case before that and begin counting the person years after the second month.

```{r}
#incidence

tb_incidence <- sum(hiv$case_incident_2m == 1) #15 incidences

tb_incidence_personyears <- hiv %>%
  mutate(art_start_date_2m = art_start_date + months(2),  # Calculate the date 2 months after art_start_date
         persontime = ifelse(case_incident_2m == 1,
                             as.numeric(difftime(date_tb, art_start_date_2m, units = "days")) / 360,  # time between 2 months after art_start_date and date_tb in years
                             ifelse(!is.na(exitdate),
                                    as.numeric(difftime(exitdate, art_start_date_2m, units = "days")) / 360,  # time between 2 months after art_start_date and exitdate in years
                                    as.numeric(difftime(as.Date("2022-12-31"), art_start_date_2m, units = "days")) /360  # time between 2 months after art_start_date and 31.12.2022 in years
                             ))) %>% 
  filter(persontime > 0)

person_years <- sum(tb_incidence_personyears$persontime)
incidence_rate = (tb_incidence/person_years)*100000

#time to tb
time_to_tb <- tb %>% 
  mutate(time_to_tb = as.numeric(date_tb-art_start_date)) %>% 
  summarise(median = median(time_to_tb))

#incidence of viral suppression


```

## Plots

```{r}


# And plot

rna_long_tb <- rna_long %>% 
  filter(id %in% tb$id) 

ggplot(rna_long, aes(x = time_diff, y = rnarna_values)) +
  geom_line() +
  facet_wrap(~ id) +
  scale_y_sqrt() +
  labs(x = "Time", y = "rnarna (square root scale)") +
  theme_minimal()

ggplot(rna_long_tb, aes(x = time_diff, y = rnarna_values)) +
  geom_line() +
  facet_wrap(~ id) +
  scale_y_sqrt() +
  labs(x = "Time", y = "rnarna (square root scale)") +
  theme_minimal()

#cd4



```
