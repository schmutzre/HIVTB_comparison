---
title: "EDA"
author: "Remo Schmutz"
date: "2023-10-28"
output:
  html_document: default
  fig_caption: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE)
library(table1)
library(tidyverse)
library(knitr)
library(png)
```

# Table 1

```{r, include=FALSE}

complete <-  readRDS("../../data_clean/art.rds")

# Columns #

complete$presenting_tb <- 
  factor(complete$presenting_tb, 
         levels=c(0,1),
         labels=c("Not presenting with TB", # Reference
                  "Presenting with TB"))

# Age #

label(complete$age_at_art_start) <- "Age at start of ART"

# Sex #

complete$sex <- 
  factor(complete$sex, 
         levels=c("Male","Female"))
label(complete$sex) <- "Sex"

# Site of TB #

label(complete$site_tb) <- "Site of TB"

# Source of original HIV infection #

complete$risk <- 
  factor(complete$risk, 
         levels=c("Homosexual","Heterosexual","IVD, needle sharing", "IVD/sexual", 
                  "Other blood products", "Perinatal", "Other sources"),
         labels = c("Homosexual contacts", "Heterosexual contacts", "I.v. drug use (with needle sharing)", "I.v. drugs/sexual contacts (unclear which one)", "Other blood products", "Perinatal transmission", "Other sources"))

label(complete$risk) <- "Source of original HIV infection"

# CD4 baseline #

label(complete$cd4_baseline) <- "CD4 cell count at start of ART"

# Viral load baseline #

label(complete$rna_baseline) <- "HIV RNA viral load at start of ART"

# WHO stage #

label(complete$who_stage) <- "WHO clinical stage"

# HIV treatment regimens #

label(complete$regimen) <- "HIV treatment regimens"
```

```{r echo=FALSE, fig.align='center'}
table1(~ age_at_art_start + sex + site_tb + risk + cd4_baseline + rna_baseline + who_stage + regimen | cohort * presenting_tb, data = complete,
       overall = c(left = "All"),
       topclass="Rtable1-zebra",
       caption = "Baseline characteristics of HIV-positive patients starting antiretroviral treatment (ART) between 2010 and 2022, presenting and not presenting with TB. Patients with a TB diagnosis >12 months before ART start were excluded. We compared patients with prevalent TB (all forms, diagnosis 2 months before/after ART start) or a recent history of TB (diagnosis 2-12 months before ART start) with patients with no history of TB.")
```

# Table 2

```{r, include=FALSE}
tb <- readRDS("../../data_clean/tb.rds")

# Age #

custom_breaks <- c(16, 24, 34, 44, 100)

tb <- tb %>% 
  mutate(age_tb = year(date_tb) - year(born)) %>%  
  mutate(agegroups = cut(age_tb, breaks = custom_breaks, include.lowest = TRUE)) %>% 
  mutate(agegroups = as.factor(agegroups))

tb$agegroups <- 
  factor(tb$agegroups, 
         levels=c("[16,24]","(24,34]", "(34,44]", "(44,100]"),
         labels=c("16-24","25-34", "35-44", "45+"))

label(tb$agegroups) <- "Age when diagnosed with TB"

# Sex #

tb$sex <- 
  factor(tb$sex, 
         levels=c("Male","Female"))
label(tb$sex) <- "Sex"

# Birth country #

label(tb$region) <- "Birth country"
tb$region <- 
  factor(tb$region, 
         levels=c("Sub-Saharan Africa","Europe","North Africa" , "North America", "South/Latin America", "Oceania", "Asia"))

# Site of TB #

label(tb$site_tb) <- "Site of TB"

# CD4 cell count at TB diagnosis #

label(tb$tb_diag_cd4) <- "CD4 cell count at TB diagnosis"

# Viral load at TB diagnosis #

label(tb$tb_diag_rna) <- "HIV RNA viral load at TB diagnosis"
```

```{r echo = FALSE}
table1(~ agegroups + sex + region + site_tb + regimen_tb_group + tb_diag_cd4 + tb_diag_rna | cohort, data = tb,
       overall = c(left = "All"),
       topclass="Rtable1-zebra",
       caption = "HIV-positive patients with TB diagnosed between 2010 and 2022.")
```

<br><br> <!-- This adds two line breaks for spacing -->

# TB Incidence

![Hallo zusammen](images/incidence_rna-01.png){width="2500"} <br><br> ![](images/incidence_cd4-04.png){width="2500"} <br><br> ![The cumulative incidence rates for time to first tuberculosis incidence after ART initiation were calculated using Aalen-Johansen method, adjusting for all-cause death as a competing risk.](images/incidence_aj.png){width="1500"} <br><br> ![](images/cd4.png){width="2500"} <br><br> ![](images/rna.png){width="2500"}
