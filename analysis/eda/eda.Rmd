---
title: "EDA"
author: "Remo Schmutz"
date: "2023-11-06"
output:
  html_document: 
    fig_caption: true
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE)
library(table1)
library(tidyverse)
library(knitr)
library(png)
library(janitor)
library(flextable)
library(forcats)
```

# Table 1

```{r, include=FALSE}

complete <-  readRDS("../../data_clean/art.rds")
ch <- readRDS("../../data_clean/ch/art_ch.rds")
rsa <- readRDS("../../data_clean/rsa/art_rsa.rds")

# Columns #

complete <- complete %>%
  mutate(presenting_tb = factor(presenting_tb, levels = c(0, 1))) %>%
  mutate(presenting_tb = 
           fct_recode(presenting_tb,
                            "Not presenting with TB" = "0",
                            "Presenting with TB" = "1"),
         site_tb = case_when(presenting_tb == 0 ~ NA,
                             TRUE ~ site_tb))

# Age #

label(complete$age_at_art_start) <- "Age at start of ART"

# Sex #

complete$gender <- factor(complete$gender, 
         levels=c("Male","Female"))
label(complete$gender) <- "Gender"

# Site of TB #

complete <- complete %>% 
  mutate(site_tb = case_when(presenting_tb == "Not presenting with TB" ~ NA,
                             TRUE ~ site_tb),
         regimen_tb_group = case_when(
           presenting_tb == "Not presenting with TB" ~ NA,
           TRUE ~ regimen_tb_group))
label(complete$site_tb) <- "Site of TB"

# Source of original HIV infection #

# complete$risk <- 
#   factor(complete$risk, 
#          levels=c("Homosexual","Heterosexual","IVD, needle sharing", "IVD/sexual", 
#                   "Other blood products", "Perinatal", "Other sources"),
#          labels = c("Homosexual contacts", "Heterosexual contacts", "I.v. drug use (with needle sharing)", "I.v. drugs/sexual contacts (unclear which one)", "Other blood products", "Perinatal transmission", "Other sources"))
# 
# label(complete$risk) <- "Source of original HIV infection"

# CD4 baseline #

label(complete$cd4_baseline) <- "CD4 cell count at start of ART"

# Viral load baseline #

label(complete$rna_baseline) <- "HIV RNA viral load at start of ART"

# WHO stage #

label(complete$who_stage) <- "WHO clinical stage"

# HIV treatment regimens #

label(complete$regimen) <- "HIV treatment regimens"

# TB treatment regimens #

label(complete$regimen_tb_group) <- "TB regimen"
```

```{r echo=FALSE, fig.align='center'}
my.render.cont <- function(x) {
    stats <- stats.default(x)
    with(stats, {
        mean_sd <- sprintf("%d (%d)", round(MEAN), round(SD))
        median_iqr <- sprintf("%d [%d, %d]", round(MEDIAN), round(Q1), round(Q3))
        min_max <- sprintf("[%d, %d]", round(MIN), round(MAX))
        c("", "Mean (SD)"=mean_sd, "Median (IQR)"=median_iqr, "Min, Max"=min_max)
    })
}

my.render.cat <- function(x) {
    # Calculate the total number of non-missing values
    non_missing_total <- sum(!is.na(x))
    
    # Use stats.default to compute frequencies and percentages
    stats <- stats.default(x)
    
    # Use sapply to apply the function to each element of the stats list
    c("", sapply(stats, function(y) {
        # Calculate the percentage excluding missings
        real_pct <- if (non_missing_total > 0) {
            (y$FREQ / non_missing_total) * 100
        } else {
          NA  # Avoid division by zero if non_missing_total is zero
        }
        
        # Prepare the string with both percentages: including and excluding missings
        sprintf("%d (%0.0f%%; %0.0f%%)", y$FREQ, y$PCT, real_pct)
    }))
}


table1(~ age_at_art_start + gender + site_tb + cd4_baseline + rna_baseline + who_stage + regimen + regimen_tb_group| presenting_tb, data = complete,
       overall = c(left = "All"),
       topclass="Rtable1-zebra",
       caption = "Baseline characteristics of HIV-positive patients starting antiretroviral treatment (ART) between 2010 and 2022, presenting and not presenting with TB. Patients with a TB diagnosis >12 months before ART start were excluded. We compared patients with prevalent TB (all forms, diagnosis 2 months before/after ART start) or a recent history of TB (diagnosis 2-12 months before ART start) with patients with no history of TB.",
       render.continuous = my.render.cont,
       render.categorical = my.render.cat)
```

### Top 5 most used ART treatments per cohort

```{r echo = FALSE}
### TOP 5 ART treatments
freq_table <- tabyl(ch$treatment, show_na = FALSE)
freq_table2 <- tabyl(rsa$treatment, show_na = FALSE)

top_ch <- as.data.frame(freq_table[order(-freq_table$percent), ][1:5, ]) %>% 
  mutate(percent = round(percent*100, 0))

top_rsa <- as.data.frame(freq_table2[order(-freq_table2$percent), ][1:5, ]) %>% 
  mutate(percent = round(percent*100, 0))

kable(top_ch)
kable(top_rsa)
```

# Table 2

```{r, include=FALSE}
tb <- readRDS("../../data_clean/tb.rds")
tb_ch <- readRDS("../../data_clean/ch/tb_ch.rds")
tb_rsa <- readRDS("../../data_clean/rsa/tb_rsa.rds")
# Age #

custom_breaks <- c(16, 24, 34, 44, 100)

tb <- tb %>% 
  mutate(age_tb = year(date_tb) - year(born)) %>%  
  mutate(agegroups = cut(age_tb, breaks = custom_breaks, include.lowest = TRUE)) %>% 
  mutate(agegroups = as.factor(agegroups))

tb$agegroups <- 
  factor(tb$agegroups, 
         levels=c("[16,24]","(24,34]", "(34,44]", "(44,100]"),
         labels=c("16-24","25-34", "35-44", "45+"))

label(tb$agegroups) <- "Age when diagnosed with TB"

# Sex #

tb$sex <- 
  factor(tb$sex, 
         levels=c("Male","Female"))
label(tb$sex) <- "Sex"

# Birth country #

tb$region <- 
  factor(tb$region, 
         levels=c("Sub-Saharan Africa","Europe","North Africa" , "North America", "South/Latin America", "Oceania", "Asia"))
label(tb$region) <- "Birth country"

# TB regimen #

label(tb$regimen_tb_group) <- "TB regimen"

# Site of TB #

label(tb$site_tb) <- "Site of TB"

# CD4 cell count at TB diagnosis #

label(tb$tb_diag_cd4) <- "CD4 cell count at TB diagnosis"

# Viral load at TB diagnosis #

label(tb$tb_diag_rna) <- "HIV RNA viral load at TB diagnosis"
```

```{r echo = FALSE}
table1(~ agegroups + sex + region + site_tb + regimen_tb_group + tb_diag_cd4 + tb_diag_rna | cohort, data = tb,
       overall = c(left = "All"),
       topclass="Rtable1-zebra",
       caption = "HIV-positive patients with TB diagnosed between 2010 and 2022.",
       render.continuous = my.render.cont,
       render.categorical = my.render.cat)
```

## TB treatment separated by resistancy profile

### SHCS (0: no resistancy, 1: any resistancy)

```{r echo=FALSE, fig.align='center'}
### Treatments / TB resistance
result1 <- tb_ch %>%
  tabyl(regimen_tb_group, resistance_tb_any) 

kable(result1)
```

```{r}
check_tb <- tb_ch %>% 
  filter(resistance_tb_any == 1,
         regimen_tb_group == "Standard")
```

### Khayelitsha (0: no resistancy, 1: any resistancy)

```{r echo=FALSE, fig.align='center'}
result2 <- tb_rsa %>%
  tabyl(regimen_tb_group, resistance_tb_any) 

kable(result2)
```

# Figures

## TB Incidence per baseline groups

![Figure 1: Point-wise incidence estimate stratified by baseline viral load for Khayelitsha (left) and SHCS (right).](images/incidence_rna-03.png)

![Figure 2: Point-wise incidence estimate stratified by baseline CD4 count for Khayelitsha (left) and SHCS (right).](images/incidence_cd4-07.png)

![Figure 3: IRR compared to the reference group 350+ (CD4 at ART start) for Khayelitsha (left) and SHCS (right).](images/irr_350.png)

## Survival analysis

Option 1: side-by-side

![Figure 3: The cumulative incidence rates for time to first tuberculosis incidence after ART initiation were calculated using Aalen-Johansen method, adjusting for all-cause death as a competing risk.](images/incidence_aj_sep.png)Figure 3: The cumulative incidence rates for time to first tuberculosis incidence after ART initiation were calculated using Aalen-Johansen method, adjusting for all-cause death as a competing risk. Stratified by cohort, Khayelitsha (left) and SHCS (right).

Option 2: log-scaled

![Figure 4: The cumulative incidence rates (log10-scaled) for time to first tuberculosis incidence after ART initiation were calculated using Aalen-Johansen method, adjusting for all-cause death as a competing risk. Stratified by cohort, Khayelitsha (left) and SHCS (right).](images/incidence_aj_log.png)

## Immunological recovery slopes

![Figure 5: The model was fitted using a Generalized Additive Model (GAM) with a cubic spline smoothing term to capture non-linear trends.](images/cd4-02.png)

![Figure 6: The model was fitted using a Generalized Additive Model (GAM) with a cubic spline smoothing term to capture non-linear trends. Note, uncertainty about Art-naive status in Khayelitsha could play a role in low viral load at ART start. Displaying the non-logscaled values is difficult, as some values are extremely high.](images/rna-02.png)

## Follow-up

![Figure 7. Absolute number of deaths per period. As the two groups are unequal in size, this plot won't give us much information I guess.](images/exit_count.png)

![Figure 8: If we use this type of plot, we should probably re-define the categories. I calculate the mortality rate as number of deaths divided by number of patients in the cohort at the beginning of the period. With this approach I am unable to filter out the lost to follow-up in the last category, so I over-estimate the mortality rate in the last category.](images/exit_prop.png)

![Figure 9: Proportion of cumulative numbers over time. I like this one.](images/fup_prop.png)
